<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZASTopo Pro V11 - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØºØ±Ø¨ÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø©</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f4; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        #sidebar {
            position: absolute; top: 10px; right: 10px; width: 370px;
            background: rgba(255, 255, 255, 0.98); padding: 15px;
            border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000; max-height: 92vh; overflow-y: auto;
            border-right: 5px solid #2ecc71;
        }
        h1 { color: #2ecc71; font-size: 24px; margin: 0; text-align: center; font-weight: 800; }
        
        .header-info { text-align: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .dev-name { font-size: 14px; font-weight: bold; color: #2c3e50; margin-bottom: 5px; }
        .lab-info { font-size: 11px; color: #7f8c8d; line-height: 1.4; font-weight: 500; }
        .univ-info { font-size: 11px; color: #2980b9; font-weight: 700; margin-top: 3px; }

        h2 { font-size: 13px; color: #34495e; margin: 12px 0 5px 0; font-weight: bold; border-right: 3px solid #3498db; padding-right: 8px; }
        
        .btn-group { display: flex; gap: 5px; margin-bottom: 5px; flex-wrap: wrap; }
        button {
            flex: 1; padding: 8px; border: none; border-radius: 4px;
            cursor: pointer; background-color: #3498db; color: white;
            font-weight: 600; transition: 0.2s; font-size: 11px;
        }
        button:hover { transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .danger { background: #e74c3c; } .success { background: #27ae60; } .dark { background: #34495e; }
        .excel-btn { background: #217346; } .csv-btn { background: #d35400; } .dxf-btn { background: #e67e22; }
        .import-btn { background: #d35400; color: #fff; }
        .buffer-btn { background: #16a085; color: #fff; }
        .street-view-btn { background: #f1c40f; color: #333; }
        .go-btn { background: #2980b9; color: #fff; flex: 0 0 40px; }
        .profile-btn { background: #8e44ad; width: 100%; margin-top: 5px; display: none; }

        #chart-container { display: none; margin-top: 10px; padding: 10px; background: #fff; border: 1px solid #ddd; border-radius: 4px; }
        canvas { width: 100% !important; height: 150px !important; }

        select { width: 100%; padding: 5px; margin-bottom: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; }
        input[type="number"], input[type="text"] { padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; }
        .coord-input { width: 45%; }

        #coords-bar {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: rgba(44, 62, 80, 0.95); color: #ecf0f1;
            padding: 4px 15px; font-size: 11px; z-index: 1000;
            display: flex; justify-content: space-between; direction: ltr; font-family: monospace;
        }
        .stat-item { background: #e8f6f3; padding: 8px; margin-top: 10px; border-radius: 6px; font-size: 12px; border: 1px solid #d1f2eb; color: #16a085; }
        .slope-info { font-size: 11px; color: #333; margin-top: 5px; padding: 5px; background: #ecf0f1; border-radius: 4px; text-align: center;}
    </style>
</head>
<body>

    <div id="sidebar">
        <h1>ZASTopo Pro</h1>
        
        <div class="header-info">
            <div class="dev-name">ØªØ·ÙˆÙŠØ±: Ø²ÙƒØ±ÙŠØ§Ø¡ Ø§Ù„Ù…Ø­Ø¬ÙˆØ¨ÙŠ</div>
            <div class="lab-info">Ù…Ø®ØªØ¨Ø± Ø¯ÙŠÙ†Ø§Ù…ÙŠØ© Ø§Ù„Ø£ÙˆØ³Ø§Ø· Ø§Ù„Ø¬Ø§ÙØ© ÙˆØ§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¬Ù‡ÙˆÙŠØ©</div>
            <div class="univ-info">Ø´Ø¹Ø¨Ø© Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§ØŒ Ø¬Ø§Ù…Ø¹Ø© Ù…Ø­Ù…Ø¯ Ø§Ù„Ø£ÙˆÙ„ - ÙˆØ¬Ø¯Ø©</div>
        </div>

        <h2>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h2>
        <select id="lambert-zone" onchange="updateProjection()">
            <option value="EPSG:26191" selected>Lambert Zone I (North)</option>
            <option value="EPSG:26192">Lambert Zone II (Center)</option>
            <option value="EPSG:26194">Lambert Zone III (South)</option>
            <option value="EPSG:26195">Lambert Zone IV (Deep South)</option>
        </select>
        
        <div style="display: flex; gap: 5px; margin-bottom: 5px;">
            <input type="text" id="input-x" class="coord-input" placeholder="X Ø£Ùˆ Lat">
            <input type="text" id="input-y" class="coord-input" placeholder="Y Ø£Ùˆ Lng">
            <button class="go-btn" onclick="goToCoordinates()"><i class="fas fa-search"></i></button>
        </div>

        <div class="btn-group">
            <button onclick="locateUser()">ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ</button>
            <button class="danger" onclick="clearMap()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
        </div>

        <h2>âœï¸ Ø§Ù„Ø±Ø³Ù… ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„</h2>
        <p style="font-size:10px; color:#666;">* Ø§Ø³ØªØ®Ø¯Ù… Ø£Ø²Ø±Ø§Ø± "Edit" Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ <b>Ø§Ù„Ù…Ù…Ø­Ø§Ø© (Gomme)</b> Ù„Ù„Ø­Ø°Ù.</p>
        
        <div class="btn-group">
            <input type="file" id="file-input" accept=".kml,.gpx" style="display: none;" onchange="loadFile(this)">
            <button class="import-btn" onclick="document.getElementById('file-input').click()">ğŸ“‚ Ø§Ø³ØªÙŠØ±Ø§Ø¯ (KML/GPX)</button>
        </div>

        <div class="btn-group" style="align-items: center;">
            <input type="number" id="buffer-distance" placeholder="Ù…ØªØ±" value="50" style="width: 50px;">
            <button class="buffer-btn" onclick="createBuffer()">â­• Ù†Ø·Ø§Ù‚ Ø¹Ø§Ø²Ù„</button>
        </div>

        <button id="btn-profile" class="profile-btn" onclick="generateRealProfile()">ğŸ”ï¸ Ø±Ø³Ù… Ø§Ù„Ù…Ù‚Ø·Ø¹ Ø§Ù„Ø·Ø¨ÙˆØºØ±Ø§ÙÙŠ</button>
        
        <div id="chart-container">
            <canvas id="elevationChart"></canvas>
            <div id="slope-stats" class="slope-info"></div>
            <div style="text-align:center; margin-top:5px;">
                <button class="dark" style="width:auto; padding:4px 10px;" onclick="downloadProfileImage()">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ§Ù†</button>
            </div>
        </div>

        <h2>ğŸ“· Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„ØªØµØ¯ÙŠØ±</h2>
        <button class="street-view-btn" style="width: 100%; margin-bottom: 5px;" onclick="openStreetView()">ğŸ‘ï¸ ÙØªØ­ Google Street View</button>
        <button style="background: #2c3e50; width: 100%;" onclick="takeScreenshotAndMetadata()">ğŸ“· ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© + Ù…Ù„Ù Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª</button>

        <div class="btn-group" style="margin-top: 5px;">
            <button class="dxf-btn" onclick="downloadDXF()">DXF</button>
            <button class="excel-btn" onclick="downloadExcel()">Excel</button>
            <button class="csv-btn" onclick="downloadCSV()">CSV</button>
        </div>
        <div class="btn-group">
            <button class="success" onclick="downloadData('geojson')">GeoJSON</button>
            <button class="success" onclick="downloadData('kml')">KML</button>
        </div>

        <div id="stats" class="stat-item">Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„... (Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© ğŸ‡²ğŸ‡¦)</div>
    </div>

    <div id="map"></div>
    <div id="coords-bar">
        <span id="metric-coords">X: 000000 | Y: 000000 (Zone I)</span>
        <span id="geo-coords">Lat: 0.00000 | Lng: 0.00000</span>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    <script src="https://unpkg.com/@mapbox/togeojson@0.16.0/togeojson.js"></script>
    <script src="https://unpkg.com/leaflet-geometryutil"></script>
    <script src="https://unpkg.com/leaflet-simple-map-screenshoter"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <script>
        // ØªØ¹Ø±ÙŠÙ Ù…Ù†Ø§Ø·Ù‚ Ù„Ø§Ù…Ø¨ÙŠØ±
        proj4.defs("EPSG:26191", "+proj=lcc +lat_1=33.3 +lat_0=33.3 +lon_0=-5.4 +k_0=0.999625769 +x_0=500000 +y_0=300000 +a=6378249.2 +b=6356515 +towgs84=31,146,47,0,0,0,0 +units=m +no_defs");
        proj4.defs("EPSG:26192", "+proj=lcc +lat_1=29.7 +lat_0=29.7 +lon_0=-5.4 +k_0=0.999615596 +x_0=500000 +y_0=300000 +a=6378249.2 +b=6356515 +towgs84=31,146,47,0,0,0,0 +units=m +no_defs");
        proj4.defs("EPSG:26194", "+proj=lcc +lat_1=26.1 +lat_0=26.1 +lon_0=-5.4 +k_0=0.999616304 +x_0=500000 +y_0=400000 +a=6378249.2 +b=6356515 +towgs84=31,146,47,0,0,0,0 +units=m +no_defs");
        proj4.defs("EPSG:26195", "+proj=lcc +lat_1=22.5 +lat_0=22.5 +lon_0=-5.4 +k_0=0.999616437 +x_0=500000 +y_0=500000 +a=6378249.2 +b=6356515 +towgs84=31,146,47,0,0,0,0 +units=m +no_defs");

        var currentZone = "EPSG:26191";
        var currentZoneName = "Lambert I";

        function updateProjection() {
            var select = document.getElementById('lambert-zone');
            currentZone = select.value;
            currentZoneName = select.options[select.selectedIndex].text.split('(')[0].trim();
            document.getElementById('stats').innerHTML = "âœ… ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø¥Ù„Ù‰: " + currentZoneName;
        }

        var map = L.map('map').setView([33.3, -5.4], 6);
        var snapshoter = L.simpleMapScreenshoter({ hideElementsWithSelectors: ['.leaflet-control-container', '#sidebar', '#coords-bar'], mimeType: 'image/jpeg' }).addTo(map);

        // === Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ø®Ø±Ø§Ø¦Ø· (ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„ØªØ´Ù…Ù„ gl=MA Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ø¯ÙˆØ¯) ===
        // Hybrid (ØµÙˆØ± + Ø£Ø³Ù…Ø§Ø¡) - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØºØ±Ø¨ÙŠØ©
        var googleHybridMA = L.tileLayer('https://{s}.google.com/vt/lyrs=y&gl=MA&hl=ar&x={x}&y={y}&z={z}',{ 
            maxZoom: 22, 
            subdomains:['mt0','mt1','mt2','mt3'], 
            attribution: 'Â© Google Maps (Maroc)' 
        });

        // Streets (Ø·Ø±Ù‚ÙŠØ©) - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØºØ±Ø¨ÙŠØ©
        var googleStreetsMA = L.tileLayer('https://{s}.google.com/vt/lyrs=m&gl=MA&hl=ar&x={x}&y={y}&z={z}',{ 
            maxZoom: 22, 
            subdomains:['mt0','mt1','mt2','mt3'], 
            attribution: 'Â© Google Maps (Maroc)' 
        });

        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap', maxZoom: 19 });
        
        var baseMaps = { 
            "Google Hybrid (Ø§Ù„Ù…ØºØ±Ø¨)": googleHybridMA,
            "Google Streets (Ø·Ø±Ù‚ÙŠØ©)": googleStreetsMA,
            "OpenStreetMap": osm
        };
        
        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…ØºØ±Ø¨ÙŠØ© ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠØ©
        googleHybridMA.addTo(map);
        L.control.layers(baseMaps).addTo(map);

        var drawnItems = new L.FeatureGroup(); 
        map.addLayer(drawnItems);
        restoreSession();

        // === Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø±Ø³Ù… (Ù…Ø¹ Ø§Ù„Ù…Ù…Ø­Ø§Ø©) ===
        var drawControl = new L.Control.Draw({ 
            edit: { 
                featureGroup: drawnItems,
                remove: true, 
                edit: true    
            }, 
            draw: { 
                polygon: true, rectangle: true, circle: false,
                marker: { repeatMode: true }, 
                polyline: { shapeOptions: { color: '#8e44ad', weight: 4 } }
            } 
        });
        map.addControl(drawControl);

        var selectedPolyline = null;
        var lastSelectedLayer = null;

        // === Ø§Ù„Ø¨Ø­Ø« (Aller Ã ) ===
        function goToCoordinates() {
            var x = parseFloat(document.getElementById('input-x').value);
            var y = parseFloat(document.getElementById('input-y').value);
            if (isNaN(x) || isNaN(y)) { alert("Ø£Ø¯Ø®Ù„ Ø£Ø±Ù‚Ø§Ù…Ø§Ù‹ ØµØ­ÙŠØ­Ø©."); return; }

            if (x > 1000 || y > 1000) { // Ù„Ø§Ù…Ø¨ÙŠØ±
                try {
                    var latlng = proj4(currentZone, "EPSG:4326", [x, y]);
                    map.setView([latlng[1], latlng[0]], 16);
                    L.marker([latlng[1], latlng[0]]).addTo(map).bindPopup(`<b>ØªÙ… Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰:</b><br>X: ${x}<br>Y: ${y}`).openPopup();
                } catch(e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„."); }
            } else { // Ø¯Ø±Ø¬Ø§Øª
                map.setView([x, y], 16);
                L.marker([x, y]).addTo(map).bindPopup(`<b>Ø§Ù„Ù…ÙˆÙ‚Ø¹:</b><br>${x}, ${y}`).openPopup();
            }
        }

        // === Street View ===
        function openStreetView() {
            var c = map.getCenter();
            window.open(`https://www.google.com/maps?q&layer=c&cbll=$${c.lat},${c.lng}`, '_blank');
        }

        // === Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ===
        map.on(L.Draw.Event.CREATED, function (e) {
            drawnItems.addLayer(e.layer);
            handleLayerSelection(e.layer, e.layerType);
            saveSession();
        });
        map.on(L.Draw.Event.EDITED, saveSession);
        map.on(L.Draw.Event.DELETED, function() {
            saveSession();
            document.getElementById('stats').innerHTML = "ØªÙ… Ø§Ù„Ø­Ø°Ù.";
            selectedPolyline = null;
            lastSelectedLayer = null;
            document.getElementById('btn-profile').style.display = 'none';
        });

        drawnItems.on('click', function(e) { handleLayerSelection(e.layer, getLayerType(e.layer)); });

        function getLayerType(layer) {
            if (layer instanceof L.Marker) return 'marker';
            if (layer instanceof L.Polygon) return 'polygon';
            if (layer instanceof L.Polyline) return 'polyline';
            return 'unknown';
        }

        function handleLayerSelection(layer, type) {
            lastSelectedLayer = layer;
            calculateStats(layer, type);
            if (layer.setStyle) {
                var originalColor = layer.options.color;
                layer.setStyle({color: '#f1c40f'});
                setTimeout(() => { layer.setStyle({color: originalColor}); }, 500);
            }
            if (type === 'polyline' && !(layer instanceof L.Polygon)) {
                selectedPolyline = layer;
                document.getElementById('btn-profile').style.display = 'block';
            } else {
                document.getElementById('btn-profile').style.display = 'none';
            }
        }

        // === Ø§Ù„Ù…Ù‚Ø·Ø¹ Ø§Ù„Ø·Ø¨ÙˆØºØ±Ø§ÙÙŠ ===
        async function generateRealProfile() {
            if (!selectedPolyline) return;
            document.getElementById('stats').innerHTML = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...";
            var rawLatLngs = selectedPolyline.getLatLngs();
            if (Array.isArray(rawLatLngs[0]) && typeof rawLatLngs[0].lat === 'undefined') rawLatLngs = rawLatLngs.flat();
            
            var totalDist = 0, dists = [0];
            for(var i=0; i<rawLatLngs.length-1; i++){ totalDist += rawLatLngs[i].distanceTo(rawLatLngs[i+1]); dists.push(totalDist); }
            
            var numPoints = 100, step = totalDist / (numPoints - 1), sampledLatLngs = [];
            function getPointAtDist(targetDist) {
                for (var i = 0; i < dists.length - 1; i++) {
                    if (targetDist >= dists[i] && targetDist <= dists[i+1]) {
                        var segmentLen = dists[i+1] - dists[i];
                        if (segmentLen == 0) return rawLatLngs[i];
                        var ratio = (targetDist - dists[i]) / segmentLen;
                        return L.latLng(rawLatLngs[i].lat + (rawLatLngs[i+1].lat - rawLatLngs[i].lat) * ratio, rawLatLngs[i].lng + (rawLatLngs[i+1].lng - rawLatLngs[i].lng) * ratio);
                    }
                }
                return rawLatLngs[rawLatLngs.length - 1];
            }
            for (var k = 0; k < numPoints; k++) sampledLatLngs.push(getPointAtDist(k * step));

            var lats = sampledLatLngs.map(ll => ll.lat.toFixed(5));
            var lngs = sampledLatLngs.map(ll => ll.lng.toFixed(5));
            var url = `https://api.open-meteo.com/v1/elevation?latitude=${lats.join(',')}&longitude=${lngs.join(',')}`;

            try {
                var res = await fetch(url);
                if (!res.ok) throw new Error("API");
                var data = await res.json();
                if (data.elevation) {
                    drawChart(data.elevation, sampledLatLngs);
                    calculateSlope(data.elevation, totalDist);
                    document.getElementById('stats').innerHTML = "âœ… ØªÙ… Ø±Ø³Ù… Ø§Ù„Ù…Ù‚Ø·Ø¹.";
                }
            } catch (e) { document.getElementById('stats').innerHTML = "âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª."; }
        }

        function calculateSlope(elevations, totalDist) {
            var min = Math.min(...elevations), max = Math.max(...elevations), diff = max - min;
            var pct = (diff / totalDist) * 100;
            var deg = Math.atan(diff / totalDist) * (180 / Math.PI);
            document.getElementById('slope-stats').innerHTML = `<b>ØªØ­Ù„ÙŠÙ„:</b> Ø£Ø¯Ù†Ù‰: ${min}Ù… | Ø£Ø¹Ù„Ù‰: ${max}Ù… | Ø§Ù†Ø­Ø¯Ø§Ø±: <span style="color:${pct>15?'red':'green'}"><b>${pct.toFixed(1)}%</b> (${deg.toFixed(1)}Â°)</span>`;
        }

        var elevationChartInstance = null;
        function drawChart(elevations, latlngs) {
            document.getElementById('chart-container').style.display = 'block';
            var ctx = document.getElementById('elevationChart').getContext('2d');
            var distances = [0], total = 0;
            for(var i=0; i<latlngs.length-1; i++) { total += latlngs[i].distanceTo(latlngs[i+1]); distances.push((total/1000).toFixed(2)); }
            if (elevationChartInstance) elevationChartInstance.destroy();
            elevationChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: distances, datasets: [{ label: 'Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ (Ù…)', data: elevations, borderColor: '#8e44ad', backgroundColor: 'rgba(142, 68, 173, 0.4)', borderWidth: 2, pointRadius: 0, fill: true, tension: 0.3 }] },
                options: { responsive: true, scales: { x: { display:true, text:'ÙƒÙ…' }, y: { display:true } } }
            });
        }

        // === Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù ===
        function createBuffer() {
            if (!lastSelectedLayer) { alert("Ø­Ø¯Ø¯ Ø¹Ù†ØµØ±Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹."); return; }
            var dist = parseFloat(document.getElementById('buffer-distance').value);
            if (!dist) return;
            try {
                var buffered = turf.buffer(lastSelectedLayer.toGeoJSON(), dist/1000, {units: 'kilometers'});
                drawnItems.addLayer(L.geoJSON(buffered, { style: { color: '#16a085', dashArray: '5, 5', fillOpacity: 0.2 } }));
                saveSession(); document.getElementById('stats').innerHTML = `âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø·Ø§Ù‚.`;
            } catch(e) { alert("Ø®Ø·Ø£: " + e); }
        }

        function loadFile(input) {
            if (input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        var parser = new DOMParser(), doc = parser.parseFromString(e.target.result, "text/xml");
                        var geojson = input.files[0].name.toLowerCase().endsWith('.gpx') ? toGeoJSON.gpx(doc) : toGeoJSON.kml(doc);
                        var l = L.geoJSON(geojson, { style: {color: "#d35400", weight: 4}, pointToLayer: (f, ll) => L.marker(ll), onEachFeature: (f, l) => drawnItems.addLayer(l) });
                        if (drawnItems.getLayers().length > 0) { map.fitBounds(drawnItems.getBounds()); saveSession(); document.getElementById('stats').innerHTML = "âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯."; }
                    } catch (err) { alert("Ø®Ø·Ø£: " + err); }
                };
                reader.readAsText(input.files[0]);
            }
        }

        function saveSession() { localStorage.setItem('zastopo_session', JSON.stringify(drawnItems.toGeoJSON())); }
        function restoreSession() { var d = localStorage.getItem('zastopo_session'); if(d) L.geoJSON(JSON.parse(d), { style: {color: "#8e44ad", weight: 4}, onEachFeature: (f, l) => drawnItems.addLayer(l) }); }

        function downloadDXF() {
            if (drawnItems.getLayers().length === 0) { alert("Ø§Ø±Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹."); return; }
            let dxf = "0\nSECTION\n2\nHEADER\n9\n$ACADVER\n1\nAC1009\n0\nENDSEC\n0\nSECTION\n2\nENTITIES\n";
            drawnItems.eachLayer(l => {
                if (l.feature && l.feature.geometry.type === 'GeometryCollection') return;
                if (l instanceof L.Marker) {
                    try { let p = proj4("EPSG:4326", currentZone, [l.getLatLng().lng, l.getLatLng().lat]); dxf += `0\nPOINT\n8\nPoints\n10\n${p[0]}\n20\n${p[1]}\n30\n0.0\n`; } catch(e){}
                } else if (l instanceof L.Polyline || l instanceof L.Polygon) {
                    let ll = l.getLatLngs(); if (Array.isArray(ll[0]) && !ll[0].lat) ll = ll.flat();
                    if(!ll[0]) return;
                    dxf += `0\nLWPOLYLINE\n8\nPolygons\n90\n${ll.length}\n70\n${(l instanceof L.Polygon?1:0)}\n`;
                    ll.forEach(p => { let c = proj4("EPSG:4326", currentZone, [p.lng, p.lat]); dxf += `10\n${c[0]}\n20\n${c[1]}\n`; });
                }
            });
            dxf += "0\nENDSEC\n0\nEOF";
            downloadFile("zastopo.dxf", dxf, "application/dxf");
        }

        function downloadProfileImage() { var a = document.createElement('a'); a.download = 'profile.png'; a.href = document.getElementById('elevationChart').toDataURL(); a.click(); }
        function calculateStats(l, t) {
            if (t === 'polyline') { var d=0, ll=l.getLatLngs(); for(var i=0;i<ll.length-1;i++) d+=ll[i].distanceTo(ll[i+1]); document.getElementById('stats').innerHTML = `ğŸ“ Ø§Ù„Ù…Ø³Ø§ÙØ©: ${(d/1000).toFixed(3)} ÙƒÙ…`; }
            else if (t === 'polygon') document.getElementById('stats').innerHTML = `ğŸ“ Ø§Ù„Ù…Ø³Ø§Ø­Ø©: ${(L.GeometryUtil.geodesicArea(l.getLatLngs()[0])/10000).toFixed(4)} Ù‡ÙƒØªØ§Ø±`;
            else document.getElementById('stats').innerHTML = "ğŸ“ Ø¹Ù†ØµØ± Ù…Ø­Ø¯Ø¯";
        }
        map.on('mousemove', e => {
            document.getElementById('geo-coords').innerText = `Lat: ${e.latlng.lat.toFixed(5)} | Lng: ${e.latlng.lng.toFixed(5)}`;
            try { var p = proj4("EPSG:4326", currentZone, [e.latlng.lng, e.latlng.lat]); document.getElementById('metric-coords').innerText = `X: ${p[0].toFixed(0)} | Y: ${p[1].toFixed(0)} (${currentZoneName})`; } catch(e){}
        });
        function getDrawnDataArray() {
            var data = [];
            drawnItems.eachLayer(l => {
                if (l.feature && l.feature.geometry.type === 'GeometryCollection') return;
                var s = { Type: "Unknown" };
                if (l instanceof L.Marker) { s.Type="Point"; let p=proj4("EPSG:4326", currentZone, [l.getLatLng().lng, l.getLatLng().lat]); s.X=p[0].toFixed(2); s.Y=p[1].toFixed(2); }
                else if (l instanceof L.Polygon) { s.Type="Polygon"; s.Metric=(L.GeometryUtil.geodesicArea(l.getLatLngs()[0])/10000).toFixed(4)+" Ha"; }
                else if (l instanceof L.Polyline) { var d=0, ll=l.getLatLngs(); for(var i=0;i<ll.length-1;i++) d+=ll[i].distanceTo(ll[i+1]); s.Type="Line"; s.Metric=(d/1000).toFixed(3)+" KM"; }
                data.push(s);
            });
            return data;
        }
        function downloadExcel() { var d=getDrawnDataArray(); if(!d.length) return alert("ÙØ§Ø±Øº"); var w=XLSX.utils.json_to_sheet(d), b=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(b,w,"Data"); XLSX.writeFile(b,"zastopo.xlsx"); }
        function downloadCSV() { var d=getDrawnDataArray(); if(!d.length) return alert("ÙØ§Ø±Øº"); var c=XLSX.utils.sheet_to_csv(XLSX.utils.json_to_sheet(d)); downloadFile("zastopo.csv",c,"text/csv"); }
        function takeScreenshotAndMetadata() {
            var b=map.getBounds(), m=`TL: ${b.getNorthEast().lat}, ${b.getSouthWest().lng}\nBR: ${b.getSouthWest().lat}, ${b.getNorthEast().lng}`;
            downloadFile("meta.txt",m,"text/plain");
            setTimeout(()=>snapshoter.takeScreen('image').then(i=>{var a=document.createElement('a'); a.download="map.jpg"; a.href=i; a.click();}),500);
        }
        function downloadData(f) { var d=drawnItems.toGeoJSON(); if(!d.features.length) return alert("ÙØ§Ø±Øº"); downloadFile("data."+f, f==='geojson'?JSON.stringify(d):toKML(d), f==='geojson'?"application/json":"application/xml"); }
        function downloadFile(n,c,t) { var b=new Blob([c],{type:t}), a=document.createElement("a"); a.href=URL.createObjectURL(b); a.download=n; a.click(); }
        function toKML(g){return `<?xml version="1.0"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document>${g.features.map(f=>`<Placemark>${f.geometry.type==="Point"?`<Point><coordinates>${f.geometry.coordinates.join(",")}</coordinates></Point>`:`<LineString><coordinates>${f.geometry.coordinates.map(c=>c.join(",")).join(" ")}</coordinates></LineString>`}</Placemark>`).join("")}</Document></kml>`;}
        function clearMap() { drawnItems.clearLayers(); localStorage.removeItem('zastopo_session'); selectedPolyline=null; lastSelectedLayer=null; document.getElementById('btn-profile').style.display='none'; document.getElementById('chart-container').style.display='none'; document.getElementById('stats').innerHTML="ØªÙ… Ø§Ù„Ù…Ø³Ø­."; }
        function locateUser() { map.locate({setView:true, maxZoom:15}); }
    </script>
</body>
</html>
