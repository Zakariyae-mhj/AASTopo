<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZASTopo - Ù…Ù†ØµØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f4; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
        #sidebar {
            position: absolute; top: 10px; right: 10px; width: 320px;
            background: rgba(255, 255, 255, 0.98); padding: 20px;
            border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000; max-height: 90vh; overflow-y: auto;
            border-right: 5px solid #2ecc71;
        }
        h1 { color: #2ecc71; font-size: 26px; margin: 0; text-align: center; font-weight: 800; letter-spacing: 1px; }
        .sub-title { text-align: center; font-size: 13px; color: #7f8c8d; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        h2 { font-size: 15px; color: #34495e; margin: 15px 0 5px 0; font-weight: bold; border-right: 3px solid #3498db; padding-right: 8px; }
        
        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ù…Ø¯Ø®Ù„Ø§Øª */
        .btn-group { display: flex; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
        button {
            flex: 1; padding: 10px; border: none; border-radius: 6px;
            cursor: pointer; background-color: #3498db; color: white;
            font-weight: 600; transition: 0.2s; font-size: 13px;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        button.danger { background-color: #e74c3c; }
        button.success { background-color: #27ae60; }
        button.warning { background-color: #f39c12; color: #fff; }

        select, input[type="date"] {
            width: 100%; padding: 8px; margin-bottom: 10px;
            border: 1px solid #ddd; border-radius: 6px;
            background: #f9f9f9; font-family: inherit;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª */
        #coords-bar {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: rgba(44, 62, 80, 0.9); color: #ecf0f1;
            padding: 8px 20px; font-size: 13px; z-index: 1000;
            display: flex; justify-content: space-between; direction: ltr;
            font-family: 'Courier New', monospace;
        }
        .stat-item { background: #e8f6f3; padding: 12px; margin-top: 5px; border-radius: 6px; font-size: 14px; border: 1px solid #d1f2eb; color: #16a085; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h1>ZASTopo</h1>
        <div class="sub-title">ØªØ·ÙˆÙŠØ±: Ø²ÙƒØ±ÙŠØ§Ø¡ Ø§Ù„Ù…Ø­Ø¬ÙˆØ¨ÙŠ</div>
        
        <h2>ğŸ›°ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Sentinel-2</h2>
        <label style="font-size:12px;">ØªØ§Ø±ÙŠØ® Ø§Ù„ØµÙˆØ±Ø©:</label>
        <input type="date" id="sentinel-date" value="2023-12-01">
        
        <label style="font-size:12px;">Ø§Ù„Ù…Ø¤Ø´Ø± (Index):</label>
        <select id="sentinel-layer-select">
            <option value="TRUE-COLOR">Ø£Ù„ÙˆØ§Ù† Ø·Ø¨ÙŠØ¹ÙŠØ© (True Color)</option>
            <option value="NDVI">Ø§Ù„ØºØ·Ø§Ø¡ Ø§Ù„Ù†Ø¨Ø§ØªÙŠ (NDVI)</option>
            <option value="NDWI">Ø§Ù„Ù…ÙŠØ§Ù‡ (NDWI)</option>
            <option value="NDMI">Ù…Ø¤Ø´Ø± Ø§Ù„Ø±Ø·ÙˆØ¨Ø© (NDMI)</option>
            <option value="FALSE-COLOR">Ø£Ø´Ø¹Ø© ØªØ­Øª Ø­Ù…Ø±Ø§Ø¡ (False Color)</option>
        </select>
        <button class="warning" onclick="updateSentinel()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ù…Ø± Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</button>

        <h2>ğŸ“ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø±Ø³Ù…</h2>
        <div class="btn-group">
            <button onclick="locateUser()">ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ</button>
            <button class="danger" onclick="clearMap()">ğŸ—‘ï¸ Ù…Ø³Ø­</button>
        </div>

        <h2>ğŸ“¥ Ø§Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„</h2>
        <div class="btn-group">
            <button class="success" onclick="downloadData('geojson')">GeoJSON</button>
            <button class="success" onclick="downloadData('kml')">KML</button>
        </div>
        <button style="background: #8e44ad; width: 100%; margin-top: 5px;" onclick="takeScreenshot()">ğŸ“· ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© (JPG)</button>

        <h2>ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
        <div id="stats" class="stat-item">
            Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„...
        </div>
    </div>

    <div id="map"></div>
    
    <div id="coords-bar">
        <span id="metric-coords">X: 000000 | Y: 000000 (Lambert I)</span>
        <span id="geo-coords">Lat: 0.00 | Lng: 0.00</span>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    <script src="https://unpkg.com/@mapbox/togeojson@0.16.0/togeojson.js"></script>
    <script src="https://unpkg.com/leaflet-geometryutil"></script>
    <script src="https://unpkg.com/leaflet-simple-map-screenshoter"></script>

    <script>
        // 1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        var map = L.map('map').setView([33.3, -5.4], 6);

        // Ø¥Ø¶Ø§ÙØ© Ø£Ø¯Ø§Ø© Ø§Ù„ØªØµÙˆÙŠØ±
        var snapshotOptions = {
            hideElementsWithSelectors: ['.leaflet-control-container', '#sidebar', '#coords-bar'],
            mimeType: 'image/jpeg'
        };
        var snapshoter = L.simpleMapScreenshoter(snapshotOptions).addTo(map);

        // 2. Ø§Ù„Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' });
        var esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Â© Esri' });
        
        // ============================================
        // ğŸ”‘ Ù…ÙØªØ§Ø­ SENTINEL HUB Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
        // ============================================
        var sentinelHubID = "fde278a6-6830-4065-a2a9-bde54f22f3c6"; 

        var sentinelLayer = L.tileLayer.wms("https://services.sentinel-hub.com/ogc/wms/" + sentinelHubID, {
            format: 'image/png',
            transparent: true,
            version: '1.1.1',
            attribution: 'Â© Sentinel Hub',
            maxZoom: 16
        });

        // Ø·Ø¨Ù‚Ø© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø±ÙŠØ¹
        var esriSentinel = L.tileLayer('https://clarity.maptiles.arcgis.com/arcgis/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Â© Esri Sentinel 2'
        });

        var baseMaps = {
            "Ø®Ø±ÙŠØ·Ø© Ø·Ø±Ù‚ÙŠØ©": osm,
            "ØµÙˆØ± Ø¬ÙˆÙŠØ© (Esri)": esriSat,
            "Sentinel-2 (Clarity)": esriSentinel
        };

        esriSat.addTo(map);
        L.control.layers(baseMaps).addTo(map);

        // 3. Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ù…Ø± Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
        function updateSentinel() {
            var dateInput = document.getElementById('sentinel-date').value;
            var layerIndex = document.getElementById('sentinel-layer-select').value;
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            if (map.hasLayer(sentinelLayer)) {
                map.removeLayer(sentinelLayer);
            }

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± (Sentinel Hub WMS)
            sentinelLayer.setParams({ 
                layers: layerIndex, 
                time: dateInput + '/' + dateInput 
            });

            sentinelLayer.addTo(map);
            sentinelLayer.bringToFront();
            
            document.getElementById('stats').innerHTML = `â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ± ${layerIndex} Ù„ØªØ§Ø±ÙŠØ® ${dateInput}...`;
            
            sentinelLayer.on('load', function() {
                document.getElementById('stats').innerHTML = `âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø·Ø¨Ù‚Ø© ${layerIndex} Ø¨Ù†Ø¬Ø§Ø­.`;
            });
            
            sentinelLayer.on('tileerror', function() {
                 document.getElementById('stats').innerHTML = `âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ù„Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ Ø¬Ø±Ø¨ ØªØ§Ø±ÙŠØ®Ø§Ù‹ Ø¢Ø®Ø±.`;
            });
        }

        // 4. Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø±Ø³Ù… (Ù…Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±)
        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        var drawControl = new L.Control.Draw({
            edit: { featureGroup: drawnItems },
            draw: {
                polygon: { allowIntersection: false, showArea: true },
                polyline: { shapeOptions: { color: '#f357a1' } },
                marker: true,
                circle: false,
                rectangle: true
            }
        });
        map.addControl(drawControl);

        proj4.defs("EPSG:26191", "+proj=lcc +lat_1=33.3 +lat_0=33.3 +lon_0=-5.4 +k_0=0.999625769 +x_0=500000 +y_0=300000 +a=6378249.2 +b=6356515 +towgs84=31,146,47,0,0,0,0 +units=m +no_defs");

        map.on(L.Draw.Event.CREATED, function (e) {
            var layer = e.layer;
            drawnItems.addLayer(layer);
            calculateStats(layer, e.layerType);
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±Ø³Ù… Ù„Ù„Ù†Ù‚Ø§Ø· ÙÙ‚Ø·
            if (e.layerType === 'marker') {
                setTimeout(function(){
                    new L.Draw.Marker(map, drawControl.options.draw.marker).enable();
                }, 100);
            }
        });

        function calculateStats(layer, type) {
            var content = "";
            if (type === 'polyline') {
                var d = 0;
                var latlngs = layer.getLatLngs();
                for (var i = 0; i < latlngs.length - 1; i++) d += latlngs[i].distanceTo(latlngs[i + 1]);
                content = `ğŸ“ Ø§Ù„Ø·ÙˆÙ„: ${(d/1000).toFixed(3)} ÙƒÙ…`;
            } else if (type === 'polygon' || type === 'rectangle') {
                var area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
                content = `ğŸ“ Ø§Ù„Ù…Ø³Ø§Ø­Ø©: ${(area/10000).toFixed(4)} Ù‡ÙƒØªØ§Ø±`;
            } else if (type === 'marker') {
                content = "ğŸ“ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø© (Ø§Ø¶ØºØ· Cancel Ù„Ù„Ø¥ÙŠÙ‚Ø§Ù)";
            }
            document.getElementById('stats').innerHTML = content;
        }

        map.on('mousemove', function(e) {
            var lat = e.latlng.lat;
            var lng = e.latlng.lng;
            document.getElementById('geo-coords').innerText = `Lat: ${lat.toFixed(5)} | Lng: ${lng.toFixed(5)}`;
            try {
                var lambert = proj4("EPSG:4326", "EPSG:26191", [lng, lat]);
                document.getElementById('metric-coords').innerText = `X: ${lambert[0].toFixed(2)} | Y: ${lambert[1].toFixed(2)}`;
            } catch(err) {}
        });

        function locateUser() { map.locate({setView: true, maxZoom: 14}); }
        function clearMap() { drawnItems.clearLayers(); document.getElementById('stats').innerHTML = "ØªÙ… Ø§Ù„Ù…Ø³Ø­"; }

        function takeScreenshot() {
            snapshoter.takeScreen('image')
                .then(image => {
                    var link = document.createElement('a');
                    link.download = "ZASTopo_Capture.jpg";
                    link.href = image;
                    link.click();
                }).catch(e => {
                    alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©: ' + e.toString());
                });
        }

        function downloadData(format) {
            var data = drawnItems.toGeoJSON();
            if (data.features.length === 0) { alert("Ø§Ø±Ø³Ù… Ø´ÙŠØ¦Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹"); return; }
            var content = format === 'geojson' ? JSON.stringify(data) : toKML(data);
            var blob = new Blob([content], {type: "text/plain"});
            var a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "zastopo." + format;
            a.click();
        }

        function toKML(geojson) {
            let kml = `<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document>`;
            geojson.features.forEach(f => {
                kml += `<Placemark><name>Feature</name>`;
                if (f.geometry.type === "Point") {
                    kml += `<Point><coordinates>${f.geometry.coordinates[0]},${f.geometry.coordinates[1]}</coordinates></Point>`;
                } else if (f.geometry.type === "Polygon") {
                    kml += `<Polygon><outerBoundaryIs><LinearRing><coordinates>`;
                    f.geometry.coordinates[0].forEach(c => { kml += `${c[0]},${c[1]} `; });
                    kml += `</coordinates></LinearRing></outerBoundaryIs></Polygon>`;
                }
                kml += `</Placemark>`;
            });
            kml += `</Document></kml>`;
            return kml;
        }
    </script>
</body>
</html>
