<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZASTopo Pro - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f4; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        #sidebar {
            position: absolute; top: 10px; right: 10px; width: 360px;
            background: rgba(255, 255, 255, 0.98); padding: 15px;
            border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000; max-height: 92vh; overflow-y: auto;
            border-right: 5px solid #2ecc71;
        }
        h1 { color: #2ecc71; font-size: 24px; margin: 0; text-align: center; font-weight: 800; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© */
        .header-info { text-align: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .dev-name { font-size: 14px; font-weight: bold; color: #2c3e50; margin-bottom: 5px; }
        .lab-info { font-size: 11px; color: #7f8c8d; line-height: 1.4; font-weight: 500; }
        .univ-info { font-size: 11px; color: #2980b9; font-weight: 700; margin-top: 3px; }

        h2 { font-size: 13px; color: #34495e; margin: 12px 0 5px 0; font-weight: bold; border-right: 3px solid #3498db; padding-right: 8px; }
        
        .btn-group { display: flex; gap: 5px; margin-bottom: 5px; flex-wrap: wrap; }
        button {
            flex: 1; padding: 8px; border: none; border-radius: 4px;
            cursor: pointer; background-color: #3498db; color: white;
            font-weight: 600; transition: 0.2s; font-size: 11px;
        }
        button:hover { transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .danger { background: #e74c3c; } .success { background: #27ae60; } .dark { background: #34495e; }
        .excel-btn { background: #217346; } .csv-btn { background: #d35400; } .dxf-btn { background: #e67e22; }
        .profile-btn { background: #8e44ad; width: 100%; margin-top: 5px; display: none; }

        #chart-container { display: none; margin-top: 10px; padding: 10px; background: #fff; border: 1px solid #ddd; border-radius: 4px; }
        canvas { width: 100% !important; height: 150px !important; }

        #coords-bar {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: rgba(44, 62, 80, 0.95); color: #ecf0f1;
            padding: 4px 15px; font-size: 11px; z-index: 1000;
            display: flex; justify-content: space-between; direction: ltr; font-family: monospace;
        }
        .stat-item { background: #e8f6f3; padding: 8px; margin-top: 10px; border-radius: 6px; font-size: 12px; border: 1px solid #d1f2eb; color: #16a085; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h1>ZASTopo Pro</h1>
        
        <div class="header-info">
            <div class="dev-name">ØªØ·ÙˆÙŠØ±: Ø²ÙƒØ±ÙŠØ§Ø¡ Ø§Ù„Ù…Ø­Ø¬ÙˆØ¨ÙŠ</div>
            <div class="lab-info">Ù…Ø®ØªØ¨Ø± Ø¯ÙŠÙ†Ø§Ù…ÙŠØ© Ø§Ù„Ø£ÙˆØ³Ø§Ø· Ø§Ù„Ø¬Ø§ÙØ© ÙˆØ§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¬Ù‡ÙˆÙŠØ©</div>
            <div class="univ-info">Ø´Ø¹Ø¨Ø© Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§ØŒ Ø¬Ø§Ù…Ø¹Ø© Ù…Ø­Ù…Ø¯ Ø§Ù„Ø£ÙˆÙ„ - ÙˆØ¬Ø¯Ø©</div>
        </div>

        <h2>âœï¸ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø±Ø³Ù… (Ù…Ø³ØªØ±Ø³Ù„Ø©)</h2>
        <div class="btn-group">
            <button onclick="locateUser()">ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ</button>
            <button class="danger" onclick="clearMap()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
        </div>
        <p style="font-size:10px; color:#666; margin-top:2px;">* Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø±Ø³Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Cancel Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©.</p>

        <button id="btn-profile" class="profile-btn" onclick="generateRealProfile()">ğŸ”ï¸ Ø±Ø³Ù… Ø§Ù„Ù…Ù‚Ø·Ø¹ Ø§Ù„Ø·Ø¨ÙˆØºØ±Ø§ÙÙŠ</button>
        <div id="chart-container">
            <canvas id="elevationChart"></canvas>
            <div style="text-align:center; margin-top:5px;">
                <button class="dark" style="width:auto; padding:4px 10px;" onclick="downloadProfileImage()">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ§Ù†</button>
            </div>
        </div>

        <h2>ğŸ› ï¸ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©</h2>
        <div class="btn-group">
            <button class="dark" onclick="toggleGraticule()">ğŸŒ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø¨ÙƒØ©</button>
        </div>

        <h2>ğŸ“· Ù„Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ (ArcGIS)</h2>
        <button style="background: #2c3e50; width: 100%;" onclick="takeScreenshotAndMetadata()">ğŸ“· ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© + Ù…Ù„Ù Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª</button>

        <h2>ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
        <div class="btn-group">
            <button class="dxf-btn" onclick="downloadDXF()">DXF (AutoCAD)</button>
        </div>
        <div class="btn-group">
            <button class="excel-btn" onclick="downloadExcel()">Excel</button>
            <button class="csv-btn" onclick="downloadCSV()">CSV</button>
        </div>
        <div class="btn-group">
            <button class="success" onclick="downloadData('geojson')">GeoJSON</button>
            <button class="success" onclick="downloadData('kml')">KML</button>
        </div>

        <div id="stats" class="stat-item">Ø§Ø±Ø³Ù… Ø¹Ù†ØµØ±Ø§Ù‹ Ù„Ù„Ø¨Ø¯Ø¡...</div>
    </div>

    <div id="map"></div>
    <div id="coords-bar">
        <span id="metric-coords">X: 000000 | Y: 000000 (Lambert I)</span>
        <span id="geo-coords">Lat: 0.00000 | Lng: 0.00000</span>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    <script src="https://unpkg.com/@mapbox/togeojson@0.16.0/togeojson.js"></script>
    <script src="https://unpkg.com/leaflet-geometryutil"></script>
    <script src="https://unpkg.com/leaflet-simple-map-screenshoter"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>L.GridLayer.Graticule=L.GridLayer.extend({options:{showLabel:!0,opacity:1,weight:0.8,color:"#333",font:"10px Verdana",dashArray:[4,4],minZoom:5},createTile:function(t){var e=this.getTileSize(),i=L.DomUtil.create("canvas","leaflet-tile");i.width=e.x,i.height=e.y;var a=i.getContext("2d");a.beginPath(),a.strokeStyle=this.options.color,a.lineWidth=this.options.weight,a.setLineDash(this.options.dashArray),a.font=this.options.font,a.fillStyle=this.options.color;var o=this._map.unproject(t.multiplyBy(e.x)),n=this._map.unproject(t.add([1,1]).multiplyBy(e.x)),s=this._map.project([n.lat,o.lng]),l=t.multiplyBy(e.x).subtract(s);o.lng>n.lng&&(l.x+=this._map.getSize().x);for(var r=this._getWrapTileNum(),h=Math.floor(o.lat/r)*r;h>n.lat;h-=r){var c=this._map.project([h,o.lng]).subtract(s).add(l);if(c.y>0&&c.y<e.y){a.moveTo(0,c.y),a.lineTo(e.x,c.y);if(this.options.showLabel){var d=h.toFixed(2);a.fillText(d,2,c.y-2)}}}for(var g=Math.floor(o.lng/r)*r;g<n.lng;g+=r){var u=this._map.project([o.lat,g]).subtract(s).add(l);if(u.x>0&&u.x<e.x){a.moveTo(u.x,0),a.lineTo(u.x,e.y);if(this.options.showLabel){var p=g.toFixed(2);a.fillText(p,u.x+2,e.y-2)}}}return a.stroke(),i},_getWrapTileNum:function(){var t=this._map.getZoom(),e=40;return t<3&&(e=20),t<5&&(e=10),t<7&&(e=5),t<9&&(e=2),t<11&&(e=1),t<13&&(e=.5),t<15&&(e=.1),e}});L.gridLayer.graticule=function(t){return new L.GridLayer.Graticule(t)};</script>

    <script>
        // ØªØ¹Ø±ÙŠÙ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Lambert Zone 1
        proj4.defs("EPSG:26191", "+proj=lcc +lat_1=33.3 +lat_0=33.3 +lon_0=-5.4 +k_0=0.999625769 +x_0=500000 +y_0=300000 +a=6378249.2 +b=6356515 +towgs84=31,146,47,0,0,0,0 +units=m +no_defs");

        var map = L.map('map').setView([33.3, -5.4], 6);
        
        var snapshoter = L.simpleMapScreenshoter({
            hideElementsWithSelectors: ['.leaflet-control-container', '#sidebar', '#coords-bar'],
            mimeType: 'image/jpeg'
        }).addTo(map);

        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' });
        var esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Â© Esri' });
        
        var baseMaps = { "Ø®Ø±ÙŠØ·Ø© Ø·Ø±Ù‚ÙŠØ©": osm, "ØµÙˆØ± Ø¬ÙˆÙŠØ© (Esri)": esriSat };
        esriSat.addTo(map);
        L.control.layers(baseMaps).addTo(map);

        var graticule = L.gridLayer.graticule({ showLabel: true, opacity: 0.6, color: '#2c3e50', weight: 0.8 });
        function toggleGraticule() {
            if (map.hasLayer(graticule)) { map.removeLayer(graticule); } else { map.addLayer(graticule); }
        }

        var drawnItems = new L.FeatureGroup(); map.addLayer(drawnItems);
        var drawControl = new L.Control.Draw({ 
            edit: { featureGroup: drawnItems }, 
            draw: { 
                polygon: true, rectangle: true, circle: false,
                marker: { repeatMode: true }, 
                polyline: { shapeOptions: { color: '#8e44ad', weight: 4 } }
            } 
        });
        map.addControl(drawControl);

        var selectedPolyline = null;

        // === 1. Ø§Ù„Ø±Ø³Ù… (Ù…Ø³ØªØ±Ø³Ù„) ===
        map.on(L.Draw.Event.CREATED, function (e) {
            drawnItems.addLayer(e.layer);
            calculateStats(e.layer, e.layerType);

            if (e.layerType === 'polyline') {
                selectedPolyline = e.layer;
                document.getElementById('btn-profile').style.display = 'block';
                document.getElementById('stats').innerHTML = "ØªÙ… Ø±Ø³Ù… Ù…Ø³Ø§Ø±. Ø§Ø¶ØºØ· 'Ø±Ø³Ù… Ø§Ù„Ù…Ù‚Ø·Ø¹' Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ¶Ø§Ø±ÙŠØ³.";
            } else if (e.layerType === 'marker') {
                setTimeout(function(){
                    var markerDrawer = new L.Draw.Marker(map, drawControl.options.draw.marker);
                    markerDrawer.enable();
                }, 100);
            }
        });

        // === 2. Ø§Ù„Ù…Ù‚Ø·Ø¹ Ø§Ù„Ø·Ø¨ÙˆØºØ±Ø§ÙÙŠ (Ø§Ù„Ø­Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ù…Ø´ÙƒÙ„Ø©) ===
        async function generateRealProfile() {
            if (!selectedPolyline) return;
            document.getElementById('stats').innerHTML = "â³ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";

            var rawLatLngs = selectedPolyline.getLatLngs();
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø·ÙˆÙ„ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
            var totalDistanceMeters = 0;
            for(var i=0; i<rawLatLngs.length-1; i++){
                totalDistanceMeters += rawLatLngs[i].distanceTo(rawLatLngs[i+1]);
            }

            // === Ø§Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø¬Ø°Ø±ÙŠ Ù‡Ù†Ø§ ===
            // ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¯Ø¯ Ù†Ù‚Ø§Ø· Ø«Ø§Ø¨Øª (Ù…Ø«Ù„Ø§Ù‹ 80 Ù†Ù‚Ø·Ø©) Ù„ØªØ¬Ù†Ø¨ Ù…Ø´ÙƒÙ„Ø© URL Too Long
            // Ù…Ù‡Ù…Ø§ ÙƒØ§Ù† Ø·ÙˆÙ„ Ø§Ù„Ø®Ø·ØŒ Ø³Ù†Ù‚Ø³Ù…Ù‡ Ø¥Ù„Ù‰ 80 Ø¬Ø²Ø¡Ø§Ù‹ Ù…ØªØ³Ø§ÙˆÙŠØ§Ù‹ ÙÙ‚Ø·.
            var maxSamples = 80;
            var stepSize = totalDistanceMeters / maxSamples;

            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø· Ù‚ØµÙŠØ±Ø§Ù‹ Ø¬Ø¯Ø§Ù‹ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø¯Ù‚Ø© 30 Ù…ØªØ± ÙƒØ­Ø¯ Ø£Ø¯Ù†Ù‰
            if (stepSize < 30) stepSize = 30;

            var denseLatLngs = [];
            
            for (var i = 0; i < rawLatLngs.length - 1; i++) {
                var start = rawLatLngs[i];
                var end = rawLatLngs[i+1];
                var segmentDist = start.distanceTo(end);
                
                var segmentSteps = Math.floor(segmentDist / stepSize);
                
                // Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
                denseLatLngs.push(start);

                for (var j = 1; j <= segmentSteps; j++) {
                    var factor = j * stepSize / segmentDist;
                    var lat = start.lat + (end.lat - start.lat) * factor;
                    var lng = start.lng + (end.lng - start.lng) * factor;
                    denseLatLngs.push(L.latLng(lat, lng));
                }
            }
            denseLatLngs.push(rawLatLngs[rawLatLngs.length - 1]);

            // Ø­Ù…Ø§ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ©: Ø¥Ø°Ø§ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¹Ø¯Ø¯ 100ØŒ Ù†Ù‚Ù„ØµÙ‡ Ù„Ù„Ù†ØµÙ
            if (denseLatLngs.length > 100) {
                denseLatLngs = denseLatLngs.filter((_, i) => i % 2 === 0);
            }

            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ (Ø§Ù„Ø¢Ù† Ù…Ø¶Ù…ÙˆÙ† Ø£Ù„Ø§ ÙŠÙƒÙˆÙ† Ø·ÙˆÙŠÙ„Ø§Ù‹ Ø¬Ø¯Ø§Ù‹)
            var lats = denseLatLngs.map(ll => ll.lat.toFixed(5));
            var lngs = denseLatLngs.map(ll => ll.lng.toFixed(5));
            var url = `https://api.open-meteo.com/v1/elevation?latitude=${lats.join(',')}&longitude=${lngs.join(',')}`;

            try {
                var response = await fetch(url);
                if (!response.ok) throw new Error("Server Limit");
                var data = await response.json();
                
                if (data.elevation) {
                    drawChart(data.elevation, denseLatLngs);
                    document.getElementById('stats').innerHTML = "âœ… ØªÙ… Ø±Ø³Ù… Ø§Ù„Ù…Ù‚Ø·Ø¹ Ø¨Ù†Ø¬Ø§Ø­.";
                } else {
                    document.getElementById('stats').innerHTML = "âš ï¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©.";
                }
            } catch (error) {
                console.error(error);
                document.getElementById('stats').innerHTML = "âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±.";
                alert("ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø­Ø§ÙˆÙ„ Ø±Ø³Ù… Ø®Ø· Ø£Ù‚ØµØ± Ù‚Ù„ÙŠÙ„Ø§Ù‹.");
            }
        }

        var elevationChartInstance = null;
        function drawChart(elevations, latlngs) {
            document.getElementById('chart-container').style.display = 'block';
            var ctx = document.getElementById('elevationChart').getContext('2d');
            
            var distances = [0];
            var totalDist = 0;
            for(var i=0; i<latlngs.length-1; i++){
                totalDist += latlngs[i].distanceTo(latlngs[i+1]);
                distances.push((totalDist/1000).toFixed(2));
            }

            if (elevationChartInstance) elevationChartInstance.destroy();

            elevationChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: distances,
                    datasets: [{
                        label: 'Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ (Ù…ØªØ±)',
                        data: elevations,
                        borderColor: '#8e44ad',
                        backgroundColor: 'rgba(142, 68, 173, 0.4)',
                        borderWidth: 2,
                        pointRadius: 0, 
                        fill: true,
                        tension: 0.3 
                    }]
                },
                options: {
                    responsive: true,
                    interaction: { intersect: false, mode: 'index' },
                    scales: {
                        x: { title: { display: true, text: 'Ø§Ù„Ù…Ø³Ø§ÙØ© (ÙƒÙ…)' }, ticks: { maxTicksLimit: 8 } },
                        y: { title: { display: true, text: 'Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ (Ù…)' } }
                    }
                }
            });
        }

        // === 3. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØµØ¯ÙŠØ± (ÙƒÙ…Ø§ Ù‡ÙŠ) ===
        function downloadDXF() {
            if (drawnItems.getLayers().length === 0) { alert("Ø§Ø±Ø³Ù… Ø´ÙŠØ¦Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹!"); return; }

            let dxf = "0\nSECTION\n2\nHEADER\n9\n$ACADVER\n1\nAC1009\n0\nENDSEC\n";
            dxf += "0\nSECTION\n2\nENTITIES\n";

            drawnItems.eachLayer(function(layer) {
                if (layer instanceof L.Marker) {
                    let lat = layer.getLatLng().lat;
                    let lng = layer.getLatLng().lng;
                    try {
                        let lambert = proj4("EPSG:4326", "EPSG:26191", [lng, lat]);
                        dxf += "0\nPOINT\n8\nPoints\n10\n" + lambert[0] + "\n20\n" + lambert[1] + "\n30\n0.0\n";
                    } catch(e) {}
                } 
                else if (layer instanceof L.Polyline || layer instanceof L.Polygon) {
                    let latlngs = layer.getLatLngs();
                    if (Array.isArray(latlngs[0])) latlngs = latlngs[0]; 

                    dxf += "0\nLWPOLYLINE\n8\nPolygons\n90\n" + latlngs.length + "\n70\n" + (layer instanceof L.Polygon ? 1 : 0) + "\n";
                    
                    latlngs.forEach(ll => {
                        let lambert = proj4("EPSG:4326", "EPSG:26191", [ll.lng, ll.lat]);
                        dxf += "10\n" + lambert[0] + "\n20\n" + lambert[1] + "\n";
                    });
                }
            });

            dxf += "0\nENDSEC\n0\nEOF";
            downloadFile("zastopo_export.dxf", dxf, "application/dxf");
        }

        function downloadProfileImage() {
            var link = document.createElement('a');
            link.download = 'profile_topographique.png';
            link.href = document.getElementById('elevationChart').toDataURL();
            link.click();
        }

        function calculateStats(layer, type) {
            var content = "";
            if (type === 'polyline') {
                var d=0, ll=layer.getLatLngs(); for(var i=0;i<ll.length-1;i++) d+=ll[i].distanceTo(ll[i+1]);
                content = `ğŸ“ Ø·ÙˆÙ„ Ø§Ù„Ù…Ø³Ø§Ø±: ${(d/1000).toFixed(3)} ÙƒÙ…`;
            } else if (type === 'polygon' || type === 'rectangle') {
                var area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
                content = `ğŸ“ Ø§Ù„Ù…Ø³Ø§Ø­Ø©: ${(area/10000).toFixed(4)} Ù‡ÙƒØªØ§Ø±`;
            } else if (type === 'marker') {
                content = "ğŸ“ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø©";
            }
            document.getElementById('stats').innerHTML = content;
        }

        map.on('mousemove', function(e) {
            document.getElementById('geo-coords').innerText = `Lat: ${e.latlng.lat.toFixed(5)} | Lng: ${e.latlng.lng.toFixed(5)}`;
            try { var l = proj4("EPSG:4326", "EPSG:26191", [e.latlng.lng, e.latlng.lat]); document.getElementById('metric-coords').innerText = `X: ${l[0].toFixed(0)} | Y: ${l[1].toFixed(0)}`; } catch(e){}
        });

        function getDrawnDataArray() {
            var data = [];
            drawnItems.eachLayer(function(layer) {
                var shapeData = { Type: "Unknown", Lat: "", Lng: "", X_Lambert: "", Y_Lambert: "", MetricValue: "" };
                if (layer instanceof L.Marker) {
                    shapeData.Type = "Point"; 
                    shapeData.Lat = layer.getLatLng().lat.toFixed(6); 
                    shapeData.Lng = layer.getLatLng().lng.toFixed(6);
                    let l = proj4("EPSG:4326", "EPSG:26191", [layer.getLatLng().lng, layer.getLatLng().lat]);
                    shapeData.X_Lambert = l[0].toFixed(2); shapeData.Y_Lambert = l[1].toFixed(2);
                } else if (layer instanceof L.Polygon) {
                    shapeData.Type = "Polygon"; shapeData.MetricValue = (L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]) / 10000).toFixed(4) + " Ha";
                } else if (layer instanceof L.Polyline) {
                    var d=0, ll=layer.getLatLngs(); for(var i=0;i<ll.length-1;i++) d+=ll[i].distanceTo(ll[i+1]);
                    shapeData.Type = "Line"; shapeData.MetricValue = (d/1000).toFixed(3) + " KM";
                }
                data.push(shapeData);
            });
            return data;
        }

        function downloadExcel() {
            var data = getDrawnDataArray(); if (data.length === 0) { alert("Ø§Ø±Ø³Ù… Ø´ÙŠØ¦Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹!"); return; }
            var ws = XLSX.utils.json_to_sheet(data); var wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "ZASTopo"); XLSX.writeFile(wb, "zastopo_data.xlsx");
        }
        function downloadCSV() {
            var data = getDrawnDataArray(); if (data.length === 0) { alert("Ø§Ø±Ø³Ù… Ø´ÙŠØ¦Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹!"); return; }
            var ws = XLSX.utils.json_to_sheet(data); var csv = XLSX.utils.sheet_to_csv(ws); downloadFile("zastopo_data.csv", csv, "text/csv;charset=utf-8;");
        }
        function takeScreenshotAndMetadata() {
            var bounds = map.getBounds(); var ne = bounds.getNorthEast(); var sw = bounds.getSouthWest();
            var meta = "ZASTopo Metadata (ArcGIS)\nTL: " + ne.lat.toFixed(6) + ", " + sw.lng.toFixed(6) + "\nBR: " + sw.lat.toFixed(6) + ", " + ne.lng.toFixed(6);
            downloadFile("metadata.txt", meta, "text/plain");
            setTimeout(() => { snapshoter.takeScreen('image').then(img => { var a = document.createElement('a'); a.download = "map_image.jpg"; a.href = img; a.click(); }); }, 500);
        }
        function downloadData(fmt) {
            var d = drawnItems.toGeoJSON(); if (d.features.length === 0) { alert("Ø§Ø±Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹"); return; }
            downloadFile("data." + fmt, fmt === 'geojson' ? JSON.stringify(d) : toKML(d), fmt === 'geojson' ? "application/json" : "application/xml");
        }
        function downloadFile(n, c, t) { var b = new Blob([c], {type: t}); var a = document.createElement("a"); a.href = URL.createObjectURL(b); a.download = n; a.click(); }
        function toKML(g){return `<?xml version="1.0"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document>${g.features.map(f=>{return `<Placemark><name>Feature</name>${f.geometry.type==="Point"?`<Point><coordinates>${f.geometry.coordinates[0]},${f.geometry.coordinates[1]}</coordinates></Point>`:f.geometry.type==="LineString"?`<LineString><coordinates>${f.geometry.coordinates.map(p=>p[0]+","+p[1]).join(" ")}</coordinates></LineString>`:`<Polygon><outerBoundaryIs><LinearRing><coordinates>${f.geometry.coordinates[0].map(p=>p[0]+","+p[1]).join(" ")}</coordinates></LinearRing></outerBoundaryIs></Polygon>`}</Placemark>`}).join("")}</Document></kml>`;}
        
        function clearMap() { drawnItems.clearLayers(); selectedPolyline = null; document.getElementById('btn-profile').style.display = 'none'; document.getElementById('chart-container').style.display = 'none'; document.getElementById('stats').innerHTML = "ØªÙ… Ø§Ù„Ù…Ø³Ø­."; }
        function locateUser() { map.locate({setView: true, maxZoom: 15}); }
    </script>
</body>
</html>
