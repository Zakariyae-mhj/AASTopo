<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZASTopo Pro | Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        /* === Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… === */
        body { margin: 0; padding: 0; font-family: 'Cairo', sans-serif; background-color: #f0f2f5; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; position: absolute; top: 0; left: 0; }
        
        /* === Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ === */
        #sidebar {
            position: absolute; top: 15px; right: 15px; width: 340px;
            background: rgba(255, 255, 255, 0.92); /* Ø´ÙØ§ÙÙŠØ© Ø®ÙÙŠÙØ© */
            backdrop-filter: blur(12px); /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø²Ø¬Ø§Ø¬ */
            padding: 0; /* Ø³Ù†Ø³ØªØ®Ø¯Ù… padding Ø¯Ø§Ø®Ù„ÙŠ */
            border-radius: 16px; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            z-index: 2000; max-height: 92vh; overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.4);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            scrollbar-width: thin; scrollbar-color: #2ecc71 #f0f0f0;
        }
        
        /* Ø±Ø£Ø³ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
        .sidebar-header {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            padding: 20px;
            border-radius: 16px 16px 0 0;
            color: white; text-align: center;
        }
        .sidebar-header h1 { margin: 0; font-size: 24px; font-weight: 800; letter-spacing: 1px; }
        .dev-name { font-size: 13px; opacity: 0.9; margin-top: 5px; font-weight: 400; }
        .header-meta { font-size: 11px; opacity: 0.8; margin-top: 2px; }

        /* Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
        .sidebar-content { padding: 15px; }

        /* === Ø§Ù„Ø£ÙƒÙˆØ±Ø¯ÙŠÙˆÙ† (Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø·ÙŠ) === */
        details {
            margin-bottom: 10px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            overflow: hidden;
            border: 1px solid #eee;
        }
        details[open] { border-color: #2ecc71; }
        summary {
            padding: 12px 15px;
            cursor: pointer;
            font-weight: 700;
            color: #34495e;
            list-style: none;
            display: flex; justify-content: space-between; align-items: center;
            transition: background 0.2s;
        }
        summary:hover { background: #f9f9f9; }
        summary::after { content: '\f078'; font-family: "Font Awesome 5 Free"; font-weight: 900; transition: 0.3s; font-size: 12px; color: #aaa; }
        details[open] summary::after { transform: rotate(180deg); color: #2ecc71; }
        .details-content { padding: 15px; border-top: 1px solid #f0f0f0; background: #fff; }

        /* === Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± === */
        .btn-group { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
        
        button {
            flex: 1; padding: 10px; border: none; border-radius: 8px;
            cursor: pointer; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 13px;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        button:active { transform: translateY(0); }

        /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn-primary { background: #3498db; color: white; } /* Ø£Ø²Ø±Ù‚ */
        .btn-success { background: #27ae60; color: white; } /* Ø£Ø®Ø¶Ø± */
        .btn-danger { background: #e74c3c; color: white; } /* Ø£Ø­Ù…Ø± */
        .btn-dark { background: #2c3e50; color: white; } /* ÙƒØ­Ù„ÙŠ */
        .btn-warning { background: #f39c12; color: white; } /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ */
        .btn-excel { background: #217346; color: white; }
        .btn-dxf { background: #e67e22; color: white; }

        /* Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
        select, input, textarea {
            width: 100%; padding: 10px; margin-bottom: 8px;
            border: 1px solid #ddd; border-radius: 8px;
            font-family: 'Cairo', sans-serif; font-size: 13px;
            box-sizing: border-box; transition: border 0.3s;
            background: #fdfdfd;
        }
        select:focus, input:focus, textarea:focus { border-color: #2ecc71; outline: none; background: #fff; }

        /* Ø®Ø§Ù†Ø© Ø§Ù„Ø¨Ø­Ø« */
        .search-box { display: flex; gap: 5px; margin-bottom: 10px; background: white; padding: 5px; border-radius: 8px; border: 1px solid #eee; }
        .search-box input { border: none; margin: 0; background: transparent; }
        .search-box button { width: 40px; flex: 0 0 40px; margin: 0; box-shadow: none; border-radius: 6px; }

        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ */
        #coords-bar {
            position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%);
            background: rgba(44, 62, 80, 0.85); backdrop-filter: blur(5px);
            color: #ecf0f1; padding: 8px 20px; font-size: 12px;
            border-radius: 30px; z-index: 1000;
            display: flex; gap: 20px; font-family: 'Consolas', monospace;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            white-space: nowrap;
        }

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        @media (max-width: 768px) {
            #sidebar {
                position: fixed; top: 0; right: 0; bottom: 0; width: 85%; height: 100vh;
                border-radius: 0; transform: translateX(110%);
                max-height: 100vh;
            }
            #sidebar.active { transform: translateX(0); }
            #coords-bar { width: 90%; bottom: 10px; font-size: 10px; gap: 10px; justify-content: center; }
            .leaflet-draw { display: none !important; } /* Ø¥Ø®ÙØ§Ø¡ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø±Ø³Ù… Ø§Ù„ÙŠØ³Ø±Ù‰ ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        }

        /* Ø­Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ */
        #save-status {
            font-size: 12px; font-weight: 700; color: #2ecc71;
            margin-bottom: 5px; text-align: center;
            background: rgba(255,255,255,0.5); padding: 4px; border-radius: 4px;
        }

        /* Ø¨Ù‚ÙŠØ© Ø§Ù„Ù†ÙˆØ§ÙØ° (Ù†ÙØ³ Ø§Ù„Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù…Ø­Ø³Ù†) */
        .auth-box { border-radius: 20px; font-family: 'Cairo', sans-serif; border: none; }
        .auth-btn { border-radius: 30px; font-weight: 700; }
        #name-modal { border-radius: 16px; font-family: 'Cairo', sans-serif; }
        
        /* Loading */
        .loader { border-top-color: #2ecc71; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="loader"></div>
        <p style="margin-top:15px; color:#2c3e50; font-weight:bold;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø´Ø±ÙˆØ¹Ùƒ...</p>
    </div>

    <div id="name-modal-overlay">
        <div id="name-modal">
            <h3>ğŸ·ï¸ Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø¹Ù†ØµØ±</h3>
            <input type="text" id="feature-name-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…Ø© (Ù…Ø«Ù„Ø§Ù‹: Ø¨Ù‚Ø¹Ø© A1)">
            <textarea id="feature-notes-input" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea>
            <button id="save-name-btn" onclick="saveFeatureName()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
        </div>
    </div>

    <div id="auth-overlay">
        <div class="auth-box">
            <h1 style="color:#2ecc71; margin:0 0 5px 0;">ZASTopo Pro</h1>
            <p style="color:#777; margin-bottom:20px; font-size:13px;">Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø°ÙƒÙŠØ© Ù„Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¬Ø§Ù„ÙŠ</p>
            <h2 id="auth-title" style="font-size:18px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <div id="auth-error"></div>
            <form id="auth-form" onsubmit="handleAuth(event)">
                <div class="signup-only">
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="fname" class="auth-input" placeholder="Ø§Ù„Ø§Ø³Ù…">
                        <input type="text" id="lname" class="auth-input" placeholder="Ø§Ù„Ù†Ø³Ø¨">
                    </div>
                    <select id="university" class="auth-input">
                        <option value="" disabled selected>Ø§Ù„Ù…Ø¤Ø³Ø³Ø© / Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©</option>
                        <option value="ump">Ø¬Ø§Ù…Ø¹Ø© Ù…Ø­Ù…Ø¯ Ø§Ù„Ø£ÙˆÙ„ - ÙˆØ¬Ø¯Ø©</option>
                        <option value="other">Ø£Ø®Ø±Ù‰</option>
                    </select>
                </div>
                <input type="email" id="email" class="auth-input" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required>
                <input type="password" id="password" class="auth-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
                <div class="signup-only">
                    <input type="password" id="confirm-password" class="auth-input" placeholder="ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±Ù…Ø²">
                </div>
                <button type="submit" class="auth-btn btn-success" id="submit-btn">Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†</button>
            </form>
            <button class="switch-btn" onclick="toggleAuthMode()" id="toggle-msg">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ø­Ø« Ø¬Ø¯ÙŠØ¯</button>
        </div>
    </div>

    <button id="menu-toggle-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>

    <div id="sidebar">
        <div class="sidebar-header">
            <button class="close-sidebar-btn" onclick="toggleSidebar()" style="position: absolute; left: 15px; top: 15px; background:none; border:none; color:white; box-shadow:none;"><i class="fas fa-times"></i></button>
            <h1>ZASTopo Pro</h1>
            <div class="dev-name">Ù…Ø±Ø­Ø¨Ø§Ù‹: Ø²Ø§Ø¦Ø±</div>
            <div class="header-meta">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ</div>
        </div>

        <div class="sidebar-content">
            <div id="save-status"><i class="fas fa-check-circle"></i> Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±</div>

            <div class="search-box">
                <input type="text" id="search-input" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆÙ‚Ø¹ (Ù…Ø¯ÙŠÙ†Ø©ØŒ Ø¯ÙˆØ§Ø±)...">
                <button onclick="searchPlace()" class="btn-primary"><i class="fas fa-search"></i></button>
            </div>

            <details open>
                <summary>ğŸŒ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª</summary>
                <div class="details-content">
                    <select id="lambert-zone" onchange="updateProjection()">
                        <optgroup label="ğŸ‡²ğŸ‡¦ Ø§Ù„Ù…ØºØ±Ø¨ (Merchich)">
                            <option value="EPSG:26191" selected>Zone I (Nord)</option>
                            <option value="EPSG:26192">Zone II (Centre)</option>
                            <option value="EPSG:26194">Zone III (Sud)</option>
                            <option value="EPSG:26195">Zone IV (Grand Sud)</option>
                        </optgroup>
                        <optgroup label="ğŸ‡©ğŸ‡¿ Ø§Ù„Ø¬Ø²Ø§Ø¦Ø± (Nord Sahara)">
                            <option value="EPSG:3059">UTM Zone 29N</option>
                            <option value="EPSG:3060">UTM Zone 30N</option>
                            <option value="EPSG:3061">UTM Zone 31N</option>
                            <option value="EPSG:3062">UTM Zone 32N</option>
                        </optgroup>
                        <optgroup label="ğŸ‡¹ğŸ‡³ ØªÙˆÙ†Ø³"> <option value="EPSG:22332">UTM Zone 32N</option> </optgroup>
                        <optgroup label="ğŸ‡±ğŸ‡¾ Ù„ÙŠØ¨ÙŠØ§"> <option value="EPSG:32632">UTM Z32</option><option value="EPSG:32633">UTM Z33</option><option value="EPSG:32634">UTM Z34</option> </optgroup>
                        <optgroup label="ğŸ‡²ğŸ‡· Ù…ÙˆØ±ÙŠØªØ§Ù†ÙŠØ§"> <option value="EPSG:32628">UTM Z28</option><option value="EPSG:32629">UTM Z29</option> </optgroup>
                        <optgroup label="ğŸ‡ªğŸ‡¬ Ù…ØµØ±"> <option value="EPSG:22992">Red Belt</option><option value="EPSG:22993">Purple Belt</option> </optgroup>
                    </select>
                    
                    <div style="display: flex; gap: 5px;">
                        <input type="text" id="input-x" placeholder="X / Lat">
                        <input type="text" id="input-y" placeholder="Y / Lng">
                        <button class="btn-primary" onclick="goToCoordinates()" style="flex: 0 0 40px;"><i class="fas fa-crosshairs"></i></button>
                    </div>
                    <div class="btn-group">
                        <button class="btn-dark" onclick="locateUser()"><i class="fas fa-location-arrow"></i> Ù…ÙˆÙ‚Ø¹ÙŠ</button>
                        <button class="btn-danger" onclick="clearMap()"><i class="fas fa-trash-alt"></i> ØªÙ†Ø¸ÙŠÙ</button>
                    </div>
                </div>
            </details>

            <details>
                <summary>âœï¸ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø±Ø³Ù… ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„</summary>
                <div class="details-content">
                    <button id="btn-sv-toggle" class="btn-warning" style="width:100%; margin-bottom:8px;" onclick="toggleStreetViewMode()">
                        <i class="fas fa-street-view"></i> Street View
                    </button>
                    <button id="btn-freehand" class="btn-dxf" onclick="toggleFreehand()" style="width:100%; margin-bottom:8px;">
                        <i class="fas fa-pencil-alt"></i> Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø­Ø± (Ù‚Ù„Ù…)
                    </button>
                    
                    <div class="btn-group" style="align-items: center;">
                        <input type="number" id="buffer-distance" placeholder="Ù…ØªØ±" value="50" style="width: 70px; margin-bottom:0;">
                        <button class="btn-dark" onclick="createBuffer()">â­• Ù†Ø·Ø§Ù‚ Ø¹Ø§Ø²Ù„</button>
                    </div>
                    <button id="btn-profile" class="btn-primary" style="width:100%; margin-top:8px; display:none;" onclick="generateRealProfile()">ğŸ”ï¸ Ø§Ù„Ù…Ù‚Ø·Ø¹ Ø§Ù„Ø·Ø¨ÙˆØºØ±Ø§ÙÙŠ</button>
                    
                    <div id="chart-container">
                        <canvas id="elevationChart"></canvas>
                        <div id="slope-stats" class="slope-info"></div>
                        <div style="text-align:center; margin-top:5px;">
                            <button class="btn-dark" style="width:auto; padding:5px 15px;" onclick="downloadProfileImage()">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ§Ù†</button>
                        </div>
                    </div>
                </div>
            </details>

            <details>
                <summary>ğŸ“¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Data)</summary>
                <div class="details-content">
                    <div class="btn-group">
                        <input type="file" id="file-input" accept=".kml,.gpx,.dxf" style="display: none;" onchange="loadFile(this)">
                        <button class="btn-primary" onclick="document.getElementById('file-input').click()">ğŸ“‚ Ø§Ø³ØªÙŠØ±Ø§Ø¯ (KML/DXF)</button>
                    </div>
                    <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
                    <button class="btn-dark" style="width:100%; margin-bottom:5px;" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
                    <button class="btn-dark" style="width:100%; margin-bottom:5px;" onclick="takeScreenshotAndMetadata()">ğŸ“· ØµÙˆØ±Ø© (JPG)</button>
                    
                    <div class="btn-group">
                        <button class="btn-dxf" onclick="downloadDXF()">DXF</button>
                        <button class="btn-excel" onclick="downloadExcel()">Excel</button>
                        <button class="btn-warning" onclick="downloadCSV()">CSV</button>
                    </div>
                    <div class="btn-group">
                        <button class="btn-success" onclick="downloadData('geojson')">GeoJSON</button>
                        <button class="btn-success" onclick="downloadData('kml')">KML</button>
                    </div>
                </div>
            </details>

            <button id="logout-btn" class="btn-danger" onclick="logoutUser()" style="margin-top:15px;"><i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬ Ø¢Ù…Ù†</button>
        </div>
    </div>

    <div id="map"></div>
    
    <div id="coords-bar">
        <span id="metric-coords">X: 0 | Y: 0</span>
        <span style="opacity:0.5">|</span>
        <span id="geo-coords">Lat: 0 | Lng: 0</span>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics-compat.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    <script src="https://unpkg.com/@mapbox/togeojson@0.16.0/togeojson.js"></script>
    <script src="https://unpkg.com/leaflet-geometryutil"></script>
    <script src="https://unpkg.com/leaflet-simple-map-screenshoter"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dxf-parser@1.1.2/dist/dxf-parser.min.js"></script>

    <script>
        // ==========================================
        // Ù†ÙØ³ ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª Ù„Ù„Ù†Ø³Ø®Ø© V36 (Ø§Ù„Ø°ÙŠ ÙŠØ¹Ù…Ù„ 100%)
        // Ø³Ø£Ù‚ÙˆÙ… Ø¨Ø¯Ù…Ø¬Ù‡ Ù‡Ù†Ø§ Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®
        // ==========================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyBHjDSoCDrZAh9KIW1LI4H6XxIdeB8YnFw",
            authDomain: "rusle-462022.firebaseapp.com",
            databaseURL: "https://rusle-462022-default-rtdb.firebaseio.com",
            projectId: "rusle-462022",
            storageBucket: "rusle-462022.firebasestorage.app",
            messagingSenderId: "106974487623",
            appId: "1:106974487623:web:f42e4cf7fd2e2218947d62",
            measurementId: "G-YVJL1T2VXM"
        };

        // ... (Ù†ÙØ³ ØªØ¹Ø±ÙŠÙØ§Øª Proj4 Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©) ...
        proj4.defs([
            ["EPSG:26191", "+proj=lcc +lat_1=33.3 +lat_0=33.3 +lon_0=-5.4 +k_0=0.999625769 +x_0=500000 +y_0=300000 +a=6378249.2 +b=6356515 +towgs84=31,146,47,0,0,0,0 +units=m +no_defs"],
            ["EPSG:26192", "+proj=lcc +lat_1=29.7 +lat_0=29.7 +lon_0=-5.4 +k_0=0.999615596 +x_0=500000 +y_0=300000 +a=6378249.2 +b=6356515 +towgs84=31,146,47,0,0,0,0 +units=m +no_defs"],
            ["EPSG:26194", "+proj=lcc +lat_1=26.1 +lat_0=26.1 +lon_0=-5.4 +k_0=0.999616304 +x_0=500000 +y_0=400000 +a=6378249.2 +b=6356515 +towgs84=31,146,47,0,0,0,0 +units=m +no_defs"],
            ["EPSG:26195", "+proj=lcc +lat_1=22.5 +lat_0=22.5 +lon_0=-5.4 +k_0=0.999616437 +x_0=500000 +y_0=500000 +a=6378249.2 +b=6356515 +towgs84=31,146,47,0,0,0,0 +units=m +no_defs"],
            ["EPSG:3059", "+proj=utm +zone=29 +ellps=clrk80 +towgs84=-186,-93,310,0,0,0,0 +units=m +no_defs"],
            ["EPSG:3060", "+proj=utm +zone=30 +ellps=clrk80 +towgs84=-186,-93,310,0,0,0,0 +units=m +no_defs"],
            ["EPSG:3061", "+proj=utm +zone=31 +ellps=clrk80 +towgs84=-186,-93,310,0,0,0,0 +units=m +no_defs"],
            ["EPSG:3062", "+proj=utm +zone=32 +ellps=clrk80 +towgs84=-186,-93,310,0,0,0,0 +units=m +no_defs"],
            ["EPSG:22332", "+proj=utm +zone=32 +ellps=clrk80ign +towgs84=-263,6,431,0,0,0,0 +units=m +no_defs"],
            ["EPSG:32628", "+proj=utm +zone=28 +datum=WGS84 +units=m +no_defs"],
            ["EPSG:32629", "+proj=utm +zone=29 +datum=WGS84 +units=m +no_defs"],
            ["EPSG:32632", "+proj=utm +zone=32 +datum=WGS84 +units=m +no_defs"],
            ["EPSG:32633", "+proj=utm +zone=33 +datum=WGS84 +units=m +no_defs"],
            ["EPSG:32634", "+proj=utm +zone=34 +datum=WGS84 +units=m +no_defs"],
            ["EPSG:22992", "+proj=tmerc +lat_0=30 +lon_0=31 +k=1 +x_0=615000 +y_0=810000 +ellps=helmert +towgs84=-130,110,-13,0,0,0,0 +units=m +no_defs"],
            ["EPSG:22993", "+proj=tmerc +lat_0=30 +lon_0=31 +k=1 +x_0=300000 +y_0=1100000 +ellps=helmert +towgs84=-130,110,-13,0,0,0,0 +units=m +no_defs"],
            ["EPSG:22994", "+proj=tmerc +lat_0=30 +lon_0=31 +k=1 +x_0=1100000 +y_0=1100000 +ellps=helmert +towgs84=-130,110,-13,0,0,0,0 +units=m +no_defs"]
        ]);

        var currentZone="EPSG:26191", currentZoneName="Lambert I";
        function updateProjection(){
            var s=document.getElementById('lambert-zone');
            currentZone=s.value; currentZoneName=s.options[s.selectedIndex].text;
        }

        var map = L.map('map', {zoomControl: false}).setView([33.3, -5.4], 6);
        L.control.zoom({position: 'topleft'}).addTo(map);
        L.control.scale({metric: true, imperial: false, position: 'bottomleft'}).addTo(map);
        
        var snapshoter = L.simpleMapScreenshoter({ hideElementsWithSelectors: ['.leaflet-control-container', '#sidebar', '#coords-bar', '#sv-modal', '#sv-overlay', '#menu-toggle-btn', '#save-status'], mimeType: 'image/jpeg' }).addTo(map);

        var googleHybridMA = L.tileLayer('https://{s}.google.com/vt/lyrs=y&gl=MA&hl=ar&x={x}&y={y}&z={z}',{ maxZoom: 22, subdomains:['mt0','mt1','mt2','mt3'], attribution: 'Google Maps' });
        var googleStreetsMA = L.tileLayer('https://{s}.google.com/vt/lyrs=m&gl=MA&hl=ar&x={x}&y={y}&z={z}',{ maxZoom: 22, subdomains:['mt0','mt1','mt2','mt3'], attribution: 'Google Maps' });
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 });
        var baseMaps = { "ØµÙˆØ± Ø¬ÙˆÙŠØ©": googleHybridMA, "Ø®Ø±ÙŠØ·Ø© Ø·Ø±Ù‚ÙŠØ©": googleStreetsMA, "OSM": osm };
        googleHybridMA.addTo(map);
        L.control.layers(baseMaps, null, {position: 'bottomleft'}).addTo(map);

        var drawnItems = new L.FeatureGroup(); map.addLayer(drawnItems);
        var drawControl = new L.Control.Draw({ edit: { featureGroup: drawnItems, remove: true }, draw: { polygon: true, rectangle: true, circle: false, marker: { repeatMode: true }, polyline: { shapeOptions: { color: '#8e44ad', weight: 4 } } } });
        map.addControl(drawControl);

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }
        map.on('click', function() { if (window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('active'); });

        try { firebase.initializeApp(firebaseConfig); } catch(e) { console.error("Firebase Config Error:", e); }
        let auth, db;
        try { auth = firebase.auth(); db = firebase.database(); } catch(e) { console.error(e); }

        let isLoginMode = true;
        if(auth) {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    document.getElementById('auth-overlay').style.display = 'none';
                    if(user.displayName) document.querySelector('.dev-name').innerText = "Ù…Ø±Ø­Ø¨Ø§Ù‹: " + user.displayName;
                    loadUserDrawings(user.uid);
                } else {
                    document.getElementById('auth-overlay').style.display = 'flex';
                    drawnItems.clearLayers();
                }
            });
        }

        // Search
        function searchPlace() {
            var query = document.getElementById('search-input').value;
            if(!query) return alert("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù†!");
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&limit=1`)
                .then(r => r.json()).then(d => {
                    if(d.length > 0) {
                        var lat = parseFloat(d[0].lat); var lon = parseFloat(d[0].lon);
                        map.setView([lat, lon], 14);
                        L.marker([lat, lon]).addTo(map).bindPopup(d[0].display_name).openPopup();
                        if(window.innerWidth <= 768) toggleSidebar();
                    } else { alert("Ù„Ù… ÙŠØ¹Ø«Ø± Ø¹Ù„ÙŠÙ‡"); }
                });
        }

        // Saving logic (Hybrid)
        let saveTimeout;
        function scheduleAutoSave() { clearTimeout(saveTimeout); saveTimeout = setTimeout(() => { saveUserDrawings(); }, 3000); }
        function saveUserDrawings() {
            if (!auth || !db) return;
            const user = auth.currentUser; if (!user) return;
            const features = [];
            drawnItems.eachLayer(layer => {
                let json = layer.toGeoJSON();
                json.properties.customName = layer.customName || "";
                json.properties.customNotes = layer.customNotes || "";
                features.push(json);
            });
            const dataToSave = { type: "FeatureCollection", features: features };
            db.ref('users/' + user.uid).set({ drawings: JSON.stringify(dataToSave), timestamp: Date.now() });
            document.getElementById('save-status').innerHTML = '<span style="color:#27ae60">âœ” ØªÙ… Ø§Ù„Ø­ÙØ¸</span>';
            setTimeout(() => { document.getElementById('save-status').innerHTML = "Ø¬Ø§Ù‡Ø²"; }, 2000);
        }

        function loadUserDrawings(uid) {
            if (!db) return;
            document.getElementById('loading-overlay').style.display = 'flex';
            db.ref('users/' + uid).once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data && data.drawings) {
                    const geojsonData = JSON.parse(data.drawings);
                    L.geoJSON(geojsonData, {
                        onEachFeature: function (feature, layer) {
                            if (feature.properties) {
                                let name = feature.properties.customName;
                                layer.customName = name;
                                layer.customNotes = feature.properties.customNotes;
                                if(name && name !== "DXF Import" && name.trim() !== "") {
                                    layer.bindTooltip(name, {permanent: true, direction: "center", className: "map-label"});
                                }
                            }
                            drawnItems.addLayer(layer);
                            attachPopup(layer);
                        }
                    });
                    if(drawnItems.getLayers().length > 0) map.fitBounds(drawnItems.getBounds());
                }
                document.getElementById('loading-overlay').style.display = 'none';
            });
        }

        map.on(L.Draw.Event.CREATED, function(e) { finishDrawing(e.layer); });
        map.on(L.Draw.Event.EDITED, function(e) { e.layers.eachLayer(l=>attachPopup(l)); scheduleAutoSave(); });
        map.on(L.Draw.Event.DELETED, function() { scheduleAutoSave(); });

        let currentLayerToName = null;
        function finishDrawing(layer) { currentLayerToName = layer; document.getElementById('feature-name-input').value = ""; document.getElementById('feature-notes-input').value = ""; document.getElementById('name-modal-overlay').style.display = 'flex'; document.getElementById('feature-name-input').focus(); }
        function saveFeatureName() {
            let name = document.getElementById('feature-name-input').value;
            let notes = document.getElementById('feature-notes-input').value;
            if(!name) name = "";
            currentLayerToName.customName = name;
            currentLayerToName.customNotes = notes;
            if(name !== "") currentLayerToName.bindTooltip(name, {permanent: true, direction: "center", className: "map-label"}).openTooltip();
            drawnItems.addLayer(currentLayerToName);
            attachPopup(currentLayerToName);
            handleSelection(currentLayerToName, (currentLayerToName instanceof L.Polygon)?'polygon':(currentLayerToName instanceof L.Polyline)?'polyline':'marker');
            document.getElementById('name-modal-overlay').style.display = 'none';
            currentLayerToName = null;
            saveUserDrawings();
        }

        // Helper functions
        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            document.querySelectorAll('.signup-only').forEach(el => el.style.display = isLoginMode ? 'none' : 'block');
            document.getElementById('auth-title').innerText = isLoginMode ? "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„" : "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨";
            document.getElementById('submit-btn').innerText = isLoginMode ? "Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†" : "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨";
            document.getElementById('toggle-msg').innerText = isLoginMode ? "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ø­Ø« Ø¬Ø¯ÙŠØ¯" : "Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ";
        }
        function handleAuth(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            if (isLoginMode) { auth.signInWithEmailAndPassword(email, pass).catch(err => alert(err.message)); } 
            else { auth.createUserWithEmailAndPassword(email, pass).then(u => { u.user.updateProfile({displayName: document.getElementById('fname').value}); location.reload(); }).catch(err => alert(err.message)); }
        }
        function logoutUser() { auth.signOut().then(() => location.reload()); }

        var isFreehand = false, freehandPolyline = null;
        function toggleFreehand() {
            isFreehand = !isFreehand;
            map.dragging[isFreehand ? 'disable' : 'enable']();
            document.getElementById('btn-freehand').classList.toggle('freehand-active');
        }
        map.on('mousedown touchstart', e => { if (isFreehand) freehandPolyline = L.polyline([e.latlng], {color: '#e74c3c', weight: 4}).addTo(map); });
        map.on('mousemove touchmove', e => { if (isFreehand && freehandPolyline) freehandPolyline.addLatLng(e.latlng); });
        map.on('mouseup touchend', () => { if (isFreehand && freehandPolyline) { finishDrawing(freehandPolyline); freehandPolyline = null; } });

        function attachPopup(layer) {
            let name = layer.customName || "Ø¹Ù†ØµØ±";
            let notes = layer.customNotes ? `<br><small style="color:gray">${layer.customNotes}</small>` : "";
            let content = `<div style="text-align:center;"><b>${name}</b>${notes}</div>`;
            
            if (layer instanceof L.Marker) {
                let ll = layer.getLatLng();
                try {
                    let p = proj4("EPSG:4326", currentZone, [ll.lng, ll.lat]);
                    content += `X: ${p[0].toFixed(0)} | Y: ${p[1].toFixed(0)}`;
                    layer.bindPopup(content).openPopup();
                } catch(e) {}
            } else if (layer instanceof L.Polyline && !(layer instanceof L.Polygon)) {
                let d = 0, ll = layer.getLatLngs(); if(Array.isArray(ll[0]) && !ll[0].lat) ll = ll.flat(); 
                for(var i=0; i<ll.length-1; i++) d += ll[i].distanceTo(ll[i+1]);
                content += `Ù…Ø³Ø§ÙØ©: ${(d/1000).toFixed(3)} km`;
                layer.bindPopup(content).openPopup();
            } else if (layer instanceof L.Polygon) {
                let area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
                content += `Ù…Ø³Ø§Ø­Ø©: ${(area/10000).toFixed(4)} Ha`;
                layer.bindPopup(content).openPopup();
            }
        }

        // ... (Ø¨Ø§Ù‚ÙŠ ÙˆØ¸Ø§Ø¦Ù DXF, Excel, etc. Ù†ÙØ³ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ØªÙ…Ø§Ù…Ø§Ù‹) ...
        function loadFile(i) {
            if(i.files[0]) {
                var r=new FileReader();
                r.onload=function(e) {
                    try {
                        let filename = i.files[0].name.toLowerCase();
                        if(filename.endsWith('.dxf')) {
                            var parser = new DxfParser();
                            var dxf = parser.parseSync(e.target.result);
                            dxf.entities.forEach(entity => {
                                let layer;
                                if(entity.type === 'POINT' || entity.type === 'INSERT') { let x = entity.position.x; let y = entity.position.y; try { let l = proj4(currentZone, "EPSG:4326", [x, y]); layer = L.marker([l[1], l[0]]); } catch(err){} } 
                                else if(entity.type === 'LWPOLYLINE' || entity.type === 'POLYLINE') { let latlngs = []; entity.vertices.forEach(v => { try { let l = proj4(currentZone, "EPSG:4326", [v.x, v.y]); latlngs.push([l[1], l[0]]); } catch(err){} }); if(latlngs.length > 0) { layer = (entity.shape || entity.closed) ? L.polygon(latlngs, {color: '#e74c3c'}) : L.polyline(latlngs, {color: '#e74c3c'}); } } 
                                else if(entity.type === 'LINE') { let latlngs = []; entity.vertices.forEach(v => { try { let l = proj4(currentZone, "EPSG:4326", [v.x, v.y]); latlngs.push([l[1], l[0]]); } catch(err){} }); if(latlngs.length > 0) layer = L.polyline(latlngs, {color: '#e74c3c'}); }
                                if(layer) { layer.customName = ""; drawnItems.addLayer(layer); attachPopup(layer); }
                            });
                            map.fitBounds(drawnItems.getBounds()); saveUserDrawings();
                        } else {
                            var p=new DOMParser(), d=p.parseFromString(e.target.result,"text/xml");
                            var g=filename.endsWith('.gpx')?toGeoJSON.gpx(d):toGeoJSON.kml(d);
                            var l=L.geoJSON(g,{style:{color:"#d35400",weight:4},pointToLayer:(f,ll)=>L.marker(ll),onEachFeature:(f,l)=>{ l.customName = f.properties.name || ""; if(l.customName) l.bindTooltip(l.customName, {permanent:true, className:'map-label'}); drawnItems.addLayer(l); attachPopup(l); }});
                            if(drawnItems.getLayers().length>0) { map.fitBounds(drawnItems.getBounds()); saveUserDrawings(); }
                        }
                    } catch(x){ alert("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­");}
                }; r.readAsText(i.files[0]);
            }
        }
        function downloadDXF(){ if(!drawnItems.getLayers().length) return alert("ÙØ§Ø±Øº"); let d="0\nSECTION\n2\nHEADER\n9\n$ACADVER\n1\nAC1009\n0\nENDSEC\n0\nSECTION\n2\nENTITIES\n"; drawnItems.eachLayer(l=>{ if(l.feature && l.feature.geometry.type==='GeometryCollection') return; if(l instanceof L.Marker) { try{ let p=proj4("EPSG:4326",currentZone,[l.getLatLng().lng,l.getLatLng().lat]); d+=`0\nPOINT\n8\nPoints\n10\n${p[0]}\n20\n${p[1]}\n30\n0.0\n`; }catch(e){} } else if(l instanceof L.Polyline||l instanceof L.Polygon) { let ll=l.getLatLngs(); if(Array.isArray(ll[0])&&!ll[0].lat) ll=ll.flat(); let closed = (l instanceof L.Polygon) ? 1 : 0; d+=`0\nLWPOLYLINE\n8\nGeometry\n90\n${ll.length}\n70\n${closed}\n`; ll.forEach((p)=>{ let c=proj4("EPSG:4326",currentZone,[p.lng,p.lat]); d+=`10\n${c[0]}\n20\n${c[1]}\n`; }); } }); d+="0\nENDSEC\n0\nEOF"; downloadFile("ZASTopo.dxf",d,"application/dxf"); }
        function downloadExcel() { var data = []; drawnItems.eachLayer(l => { let row = { Name: l.customName || "", Notes: l.customNotes || "" }; if (l instanceof L.Marker) { let p=proj4("EPSG:4326", currentZone, [l.getLatLng().lng, l.getLatLng().lat]); row.X = p[0].toFixed(2); row.Y = p[1].toFixed(2); } else if (l instanceof L.Polygon) { row.Area_Ha = (L.GeometryUtil.geodesicArea(l.getLatLngs()[0])/10000).toFixed(4); } else { let d=0, ll=l.getLatLngs(); if(Array.isArray(ll[0])&&!ll[0].lat) ll=ll.flat(); for(var i=0;i<ll.length-1;i++)d+=ll[i].distanceTo(ll[i+1]); row.Length_m = d.toFixed(2); } data.push(row); }); var w = XLSX.utils.json_to_sheet(data), b = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(b, w, "Data"); XLSX.writeFile(b, "ZASTopo.xlsx"); }
        function downloadCSV() { downloadExcel(); }
        function downloadData(f){var d=drawnItems.toGeoJSON(); if(!d.features.length)return alert("ÙØ§Ø±Øº"); downloadFile("data."+f, f==='geojson'?JSON.stringify(d):toKML(d), f==='geojson'?"application/json":"application/xml"); }
        function toKML(g){return `<?xml version="1.0"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document>${g.features.map(f=>`<Placemark><name>${f.properties.customName || ""}</name>${f.geometry.type==="Point"?`<Point><coordinates>${f.geometry.coordinates.join(",")}</coordinates></Point>`:`<LineString><coordinates>${f.geometry.coordinates.map(c=>c.join(",")).join(" ")}</coordinates></LineString>`}</Placemark>`).join("")}</Document></kml>`;}
        function downloadFile(n,c,t){var b=new Blob([c],{type:t}),a=document.createElement("a");a.href=URL.createObjectURL(b);a.download=n;a.click();}
        function goToCoordinates() { var x = parseFloat(document.getElementById('input-x').value), y = parseFloat(document.getElementById('input-y').value); if (isNaN(x) || isNaN(y)) return alert("Ø£Ø±Ù‚Ø§Ù… Ø®Ø·Ø£"); try { var l=proj4(currentZone,"EPSG:4326",[x,y]); map.setView([l[1],l[0]],16); L.marker([l[1],l[0]]).addTo(map); } catch(e){alert("Ø®Ø·Ø£ ØªØ­ÙˆÙŠÙ„");} }
        function locateUser() { map.locate({setView:true, maxZoom:15}); }
        function clearMap() { drawnItems.clearLayers(); saveUserDrawings(); }
        map.on('mousemove',e=>{ try{var p=proj4("EPSG:4326",currentZone,[e.latlng.lng,e.latlng.lat]); document.getElementById('metric-coords').innerText=`X:${p[0].toFixed(0)} Y:${p[1].toFixed(0)}`; document.getElementById('geo-coords').innerText=`Lat:${e.latlng.lat.toFixed(5)} Lng:${e.latlng.lng.toFixed(5)}`;}catch(x){} });
    </script>
</body>
</html>
