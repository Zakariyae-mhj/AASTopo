<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZASTopo Pro - Ù…Ù†ØµØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f4; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
        #sidebar {
            position: absolute; top: 10px; right: 10px; width: 340px;
            background: rgba(255, 255, 255, 0.98); padding: 15px;
            border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000; max-height: 92vh; overflow-y: auto;
            border-right: 5px solid #2ecc71;
        }
        h1 { color: #2ecc71; font-size: 24px; margin: 0; text-align: center; font-weight: 800; }
        .sub-title { text-align: center; font-size: 12px; color: #7f8c8d; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        h2 { font-size: 14px; color: #34495e; margin: 15px 0 5px 0; font-weight: bold; border-right: 3px solid #3498db; padding-right: 8px; }
        
        /* Ø§Ù„Ø¹Ù†Ø§ØµØ± */
        .btn-group { display: flex; gap: 5px; margin-bottom: 5px; flex-wrap: wrap; }
        button {
            flex: 1; padding: 8px; border: none; border-radius: 4px;
            cursor: pointer; background-color: #3498db; color: white;
            font-weight: 600; transition: 0.2s; font-size: 12px; min-width: 70px;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .danger { background: #e74c3c; } .success { background: #27ae60; } .warning { background: #f39c12; } .dark { background: #34495e; }
        .excel-btn { background: #217346; } .csv-btn { background: #d35400; }

        select, input[type="date"] {
            width: 100%; padding: 6px; margin-bottom: 5px; font-size: 12px;
            border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª */
        #coords-bar {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: rgba(44, 62, 80, 0.95); color: #ecf0f1;
            padding: 5px 15px; font-size: 11px; z-index: 1000;
            display: flex; justify-content: space-between; direction: ltr;
            font-family: 'Courier New', monospace;
        }
        .stat-item { background: #e8f6f3; padding: 10px; margin-top: 10px; border-radius: 6px; font-size: 13px; border: 1px solid #d1f2eb; color: #16a085; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø´Ø¨ÙƒØ© Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª */
        .leaflet-grid-label { color: #333; font-size: 10px; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h1>ZASTopo Pro</h1>
        <div class="sub-title">ØªØ·ÙˆÙŠØ±: Ø²ÙƒØ±ÙŠØ§Ø¡ Ø§Ù„Ù…Ø­Ø¬ÙˆØ¨ÙŠ</div>
        
        <h2>ğŸ›°ï¸ ØµÙˆØ± Ø§Ù„Ø£Ù‚Ù…Ø§Ø± Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠØ©</h2>
        <label style="font-size:11px;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ© (ÙŠØ¨Ø­Ø« ÙÙŠ Ø¢Ø®Ø± 30 ÙŠÙˆÙ…):</label>
        <input type="date" id="sentinel-date" value="2024-05-01">
        <select id="sentinel-layer-select">
            <option value="NDVI" selected>Ø§Ù„ØºØ·Ø§Ø¡ Ø§Ù„Ù†Ø¨Ø§ØªÙŠ (NDVI)</option>
            <option value="NDWI">Ø§Ù„Ù…ÙŠØ§Ù‡ (NDWI)</option>
            <option value="TRUE-COLOR">Ø£Ù„ÙˆØ§Ù† Ø·Ø¨ÙŠØ¹ÙŠØ© (True Color)</option>
            <option value="FALSE-COLOR">Ø£Ø´Ø¹Ø© ØªØ­Øª Ø­Ù…Ø±Ø§Ø¡ (False Color)</option>
        </select>
        <select id="cloud-cover">
             <option value="20">ØºÙŠÙˆÙ… < 20%</option>
             <option value="50" selected>ØºÙŠÙˆÙ… < 50%</option>
        </select>
        <button class="warning" style="width:100%" onclick="updateSentinel()">ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„ØµÙˆØ±Ø©</button>

        <h2>ğŸ› ï¸ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©</h2>
        <div class="btn-group">
            <button class="dark" onclick="toggleGraticule()">ğŸŒ Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ø¨ÙƒØ©</button>
        </div>
        <div class="btn-group">
            <button onclick="locateUser()">ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ</button>
            <button class="danger" onclick="clearMap()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
        </div>

        <h2>ğŸ“· ØªØ¬Ù‡ÙŠØ² Ù„Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ (ArcGIS)</h2>
        <p style="font-size:11px; color:#666; margin:5px 0;">Ø§Ø±Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø©ØŒ Ø«Ù… Ø­Ù…Ù„ Ø§Ù„ØµÙˆØ±Ø© ÙˆÙ…Ù„Ù Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª.</p>
        <button style="background: #8e44ad; width: 100%;" onclick="takeScreenshotAndMetadata()">ğŸ“· ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© + Ù…Ù„Ù Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª (TXT)</button>

        <h2>ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³ÙˆÙ…Ø©</h2>
        <div class="btn-group">
            <button class="excel-btn" onclick="downloadExcel()">Excel (XLSX)</button>
            <button class="csv-btn" onclick="downloadCSV()">CSV</button>
        </div>
        <div class="btn-group">
            <button class="success" onclick="downloadData('geojson')">GeoJSON</button>
            <button class="success" onclick="downloadData('kml')">KML</button>
        </div>

        <div id="stats" class="stat-item">Ø¬Ø§Ù‡Ø².</div>
    </div>

    <div id="map"></div>
    <div id="coords-bar">
        <span id="metric-coords">X: 000000 | Y: 000000 (Lambert I)</span>
        <span id="geo-coords">Lat: 0.00000 | Lng: 0.00000</span>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    <script src="https://unpkg.com/@mapbox/togeojson@0.16.0/togeojson.js"></script>
    <script src="https://unpkg.com/leaflet-geometryutil"></script>
    <script src="https://unpkg.com/leaflet-simple-map-screenshoter"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script>
        // Ø¥Ø¶Ø§ÙØ© Ø¨Ø³ÙŠØ·Ø© Ù„Ø±Ø³Ù… Ø§Ù„Ø´Ø¨ÙƒØ© (Graticule)
        L.GridLayer.Graticule = L.GridLayer.extend({options:{showLabel:!0,opacity:1,weight:0.8,color:"#aaa",font:"10px Verdana",dashArray:[5,5],minZoom:5},createTile:function(t){var e=this.getTileSize(),i=L.DomUtil.create("canvas","leaflet-tile");i.width=e.x,i.height=e.y;var a=i.getContext("2d");a.beginPath(),a.strokeStyle=this.options.color,a.lineWidth=this.options.weight,a.setLineDash(this.options.dashArray),a.font=this.options.font,a.fillStyle=this.options.color;var o=this._map.unproject(t.multiplyBy(e.x)),n=this._map.unproject(t.add([1,1]).multiplyBy(e.x)),s=this._map.project([n.lat,o.lng]),l=t.multiplyBy(e.x).subtract(s);o.lng>n.lng&&(l.x+=this._map.getSize().x);for(var r=this._getWrapTileNum(),h=Math.floor(o.lat/r)*r;h>n.lat;h-=r){var c=this._map.project([h,o.lng]).subtract(s).add(l);if(c.y>0&&c.y<e.y){a.moveTo(0,c.y),a.lineTo(e.x,c.y);if(this.options.showLabel){var d=h.toFixed(2)+"Â° N";a.fillText(d,5,c.y-2)}}}for(var g=Math.floor(o.lng/r)*r;g<n.lng;g+=r){var u=this._map.project([o.lat,g]).subtract(s).add(l);if(u.x>0&&u.x<e.x){a.moveTo(u.x,0),a.lineTo(u.x,e.y);if(this.options.showLabel){var p=g.toFixed(2)+"Â° E";a.fillText(p,u.x+2,e.y-5)}}}return a.stroke(),i},_getWrapTileNum:function(){var t=this._map.getZoom(),e=40;return t<3&&(e=20),t<5&&(e=10),t<7&&(e=5),t<9&&(e=2),t<11&&(e=1),t<13&&(e=.5),t<15&&(e=.1),e}});L.gridLayer.graticule=function(t){return new L.GridLayer.Graticule(t)};
    </script>

    <script>
        var map = L.map('map').setView([33.3, -5.4], 6);
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø¯Ø§Ø© Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±
        var snapshoter = L.simpleMapScreenshoter({
            hideElementsWithSelectors: ['.leaflet-control-container', '#sidebar', '#coords-bar'],
            mimeType: 'image/jpeg'
        }).addTo(map);

        // Ø§Ù„Ø·Ø¨Ù‚Ø§Øª
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' });
        var esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Â© Esri' });
        
        // Ù…ÙØªØ§Ø­ Sentinel Hub
        var sentinelHubID = "fde278a6-6830-4065-a2a9-bde54f22f3c6"; 
        var sentinelLayer = L.tileLayer.wms("https://services.sentinel-hub.com/ogc/wms/" + sentinelHubID, {
            format: 'image/png', transparent: true, version: '1.1.1', attribution: 'Â© Sentinel Hub', maxZoom: 16, crs: L.CRS.EPSG3857
        });

        var baseMaps = { "Ø®Ø±ÙŠØ·Ø© Ø·Ø±Ù‚ÙŠØ©": osm, "ØµÙˆØ± Ø¬ÙˆÙŠØ© (Esri)": esriSat };
        esriSat.addTo(map);
        L.control.layers(baseMaps).addTo(map);

        // Ø´Ø¨ÙƒØ© Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
        var graticule = L.gridLayer.graticule({ showLabel: true, opacity: 0.7, color: '#34495e', weight: 0.5 });
        function toggleGraticule() {
            if (map.hasLayer(graticule)) { map.removeLayer(graticule); } else { map.addLayer(graticule); }
        }

        // ØªØ­Ø¯ÙŠØ« Sentinel (Ù…Ø­Ø§ÙˆÙ„Ø© Ø£ÙØ¶Ù„)
        function updateSentinel() {
            var date = new Date(document.getElementById('sentinel-date').value);
            var startDate = new Date(date); startDate.setDate(date.getDate() - 30);
            var timeRange = startDate.toISOString().split('T')[0] + '/' + date.toISOString().split('T')[0];
            var layerIndex = document.getElementById('sentinel-layer-select').value;
            var cloud = document.getElementById('cloud-cover').value;

            if (map.hasLayer(sentinelLayer)) map.removeLayer(sentinelLayer);
            sentinelLayer.setParams({ layers: layerIndex, time: timeRange, maxcc: cloud, showLogo: false });
            sentinelLayer.addTo(map); sentinelLayer.bringToFront();
            
            document.getElementById('stats').innerHTML = `â³ Ø¬Ø§Ø±ÙŠ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ ${layerIndex}... (Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ ÙˆÙ‚ØªØ§Ù‹)`;
            sentinelLayer.on('load', () => document.getElementById('stats').innerHTML = `âœ… ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ØµØ§ÙÙŠØ©).`);
            sentinelLayer.on('tileerror', () => document.getElementById('stats').innerHTML = `âš ï¸ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„. Ø±Ø¨Ù…Ø§ ØºÙŠÙˆÙ… ÙƒØ«ÙŠÙØ© Ø£Ùˆ Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ.`);
        }

        // Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø±Ø³Ù…
        var drawnItems = new L.FeatureGroup(); map.addLayer(drawnItems);
        var drawControl = new L.Control.Draw({ edit: { featureGroup: drawnItems }, draw: { polygon: true, rectangle: true, polyline: true, marker: true, circle: false } });
        map.addControl(drawControl);

        proj4.defs("EPSG:26191", "+proj=lcc +lat_1=33.3 +lat_0=33.3 +lon_0=-5.4 +k_0=0.999625769 +x_0=500000 +y_0=300000 +a=6378249.2 +b=6356515 +towgs84=31,146,47,0,0,0,0 +units=m +no_defs");

        map.on(L.Draw.Event.CREATED, function (e) {
            drawnItems.addLayer(e.layer);
            // ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø±Ø³ÙˆÙ…
            if (e.layerType === 'polygon' || e.layerType === 'rectangle') {
                map.fitBounds(e.layer.getBounds(), {padding: [50, 50]});
            }
        });

        // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
        map.on('mousemove', function(e) {
            document.getElementById('geo-coords').innerText = `Lat: ${e.latlng.lat.toFixed(5)} | Lng: ${e.latlng.lng.toFixed(5)}`;
            try { var l = proj4("EPSG:4326", "EPSG:26191", [e.latlng.lng, e.latlng.lat]); document.getElementById('metric-coords').innerText = `X: ${l[0].toFixed(0)} | Y: ${l[1].toFixed(0)}`; } catch(e){}
        });

        // Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        function locateUser() { map.locate({setView: true, maxZoom: 15}); }
        function clearMap() { drawnItems.clearLayers(); document.getElementById('stats').innerHTML = "ØªÙ… Ø§Ù„Ù…Ø³Ø­."; }

        // =========================================
        // ğŸ†• ÙˆØ¸ÙŠÙØ© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© + Ù…Ù„Ù Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª (Metadata)
        // =========================================
        function takeScreenshotAndMetadata() {
            // 1. Ø­Ø³Ø§Ø¨ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            var bounds = map.getBounds();
            var northEast = bounds.getNorthEast();
            var southWest = bounds.getSouthWest();

            // 2. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ù†ØµÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù„Ù€ ArcGIS
            var metadataContent = 
                "ZASTopo Image Metadata for ArcGIS Georeferencing\n" +
                "------------------------------------------------\n" +
                "Use these coordinates as Control Points (DMS or DD):\n\n" +
                "Top-Left (NW) Corner:\n   Lat: " + northEast.lat.toFixed(6) + "\n   Lng: " + southWest.lng.toFixed(6) + "\n\n" +
                "Bottom-Right (SE) Corner:\n   Lat: " + southWest.lat.toFixed(6) + "\n   Lng: " + northEast.lng.toFixed(6) + "\n\n" +
                "Projection: WGS 84 (EPSG:4326)";
            
            downloadFile("image_metadata_bounds.txt", metadataContent, "text/plain");

            // 3. ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ© (Ù„Ø¶Ù…Ø§Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Øµ Ø£ÙˆÙ„Ø§Ù‹)
            setTimeout(() => {
                snapshoter.takeScreen('image').then(image => {
                    var link = document.createElement('a'); link.download = "ZASTopo_Map_Image.jpg"; link.href = image; link.click();
                }).catch(e => alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©: ' + e));
            }, 1000);
        }

        // =========================================
        // ğŸ†• ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØµØ¯ÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Excel & CSV)
        // =========================================
        function getDrawnDataArray() {
            var data = [];
            drawnItems.eachLayer(function(layer) {
                var shapeData = { Type: "Unknown", Lat: "", Lng: "", MetricValue: "" };
                if (layer instanceof L.Marker) {
                    shapeData.Type = "Point"; shapeData.Lat = layer.getLatLng().lat.toFixed(6); shapeData.Lng = layer.getLatLng().lng.toFixed(6);
                } else if (layer instanceof L.Polygon) {
                    shapeData.Type = "Polygon"; shapeData.MetricValue = (L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]) / 10000).toFixed(4) + " Hectares";
                } else if (layer instanceof L.Polyline) {
                    var d=0, ll=layer.getLatLngs(); for(var i=0;i<ll.length-1;i++) d+=ll[i].distanceTo(ll[i+1]);
                    shapeData.Type = "Line"; shapeData.MetricValue = (d/1000).toFixed(3) + " KM";
                }
                data.push(shapeData);
            });
            return data;
        }

        function downloadExcel() {
            var data = getDrawnDataArray();
            if (data.length === 0) { alert("Ø§Ø±Ø³Ù… Ø´ÙŠØ¦Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹!"); return; }
            var ws = XLSX.utils.json_to_sheet(data);
            var wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "ZASTopo Data");
            XLSX.writeFile(wb, "zastopo_data.xlsx");
        }

        function downloadCSV() {
            var data = getDrawnDataArray();
            if (data.length === 0) { alert("Ø§Ø±Ø³Ù… Ø´ÙŠØ¦Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹!"); return; }
            var ws = XLSX.utils.json_to_sheet(data);
            var csv = XLSX.utils.sheet_to_csv(ws);
            downloadFile("zastopo_data.csv", csv, "text/csv;charset=utf-8;");
        }

        // ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø©
        function downloadData(format) {
            var data = drawnItems.toGeoJSON(); if (data.features.length === 0) { alert("Ø§Ø±Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹"); return; }
            downloadFile("zastopo." + format, format === 'geojson' ? JSON.stringify(data) : toKML(data), format === 'geojson' ? "application/json" : "application/xml");
        }
        function downloadFile(filename, content, type) {
            var blob = new Blob([content], {type: type}); var a = document.createElement("a");
            a.href = URL.createObjectURL(blob); a.download = filename; a.click();
        }
        // Ø¯Ø§Ù„Ø© KML Ø¨Ø³ÙŠØ·Ø© (Ù…Ø¨Ø³Ø·Ø© Ù„Ù„Ø³Ø±Ø¹Ø©)
        function toKML(gj){return `<?xml version="1.0"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document>${gj.features.map(f=>{let c=f.geometry.coordinates;let g=f.geometry.type==="Point"?`<Point><coordinates>${c[0]},${c[1]}</coordinates></Point>`:f.geometry.type==="Polygon"?`<Polygon><outerBoundaryIs><LinearRing><coordinates>${c[0].map(p=>p[0]+","+p[1]).join(" ")}</coordinates></LinearRing></outerBoundaryIs></Polygon>`:"";return `<Placemark>${g}</Placemark>`}).join("")}</Document></kml>`;}
    </script>
</body>
</html>
