<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZASTopo Pro | Ù…Ù†ØµØ© Ø´Ù…Ø§Ù„ Ø¥ÙØ±ÙŠÙ‚ÙŠØ§</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f4; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; position: absolute; top: 0; left: 0; }
        
        #sidebar {
            position: absolute; top: 10px; right: 10px; width: 370px;
            background: rgba(255, 255, 255, 0.98); padding: 15px;
            border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 2000; max-height: 90vh; overflow-y: auto;
            border-right: 5px solid #2ecc71;
            transition: transform 0.3s ease-in-out;
            transform: translateX(0);
        }

        @media (max-width: 768px) {
            #sidebar {
                position: fixed; top: 0; right: 0; bottom: 0; width: 85%;
                border-radius: 0; transform: translateX(110%);
                max-height: 100vh; z-index: 9999;
            }
            #sidebar.active { transform: translateX(0); }
            .leaflet-draw { display: block !important; margin-top: 50px !important; }
        }

        #menu-toggle-btn { display: none; position: absolute; top: 20px; right: 20px; z-index: 3000 !important; background: #2ecc71; color: white; border: none; width: 45px; height: 45px; border-radius: 50%; font-size: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; align-items: center; justify-content: center; }
        @media (max-width: 768px) { #menu-toggle-btn { display: flex !important; } }
        .close-sidebar-btn { display: none; background: none; border: none; color: #e74c3c; font-size: 24px; cursor: pointer; position: absolute; left: 15px; top: 15px; }
        @media (max-width: 768px) { .close-sidebar-btn { display: block; } }

        #coords-bar { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(44, 62, 80, 0.9); color: #ecf0f1; padding: 8px 10px; font-size: 11px; z-index: 1000; display: flex; justify-content: space-between; direction: ltr; font-family: monospace; backdrop-filter: blur(4px); }
        .leaflet-bottom.leaflet-right { margin-bottom: 30px; }

        h1 { color: #2ecc71; font-size: 22px; margin: 0; text-align: center; font-weight: 800; margin-top: 10px; }
        .header-info { text-align: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .dev-name { font-size: 14px; font-weight: bold; color: #2c3e50; }
        .lab-info { font-size: 11px; color: #7f8c8d; font-weight: 500; }
        .univ-info { font-size: 11px; color: #2980b9; font-weight: 700; }
        h2 { font-size: 13px; color: #34495e; margin: 12px 0 5px 0; font-weight: bold; border-right: 3px solid #3498db; padding-right: 8px; }
        .btn-group { display: flex; gap: 5px; margin-bottom: 5px; flex-wrap: wrap; }
        button { flex: 1; padding: 10px; border: none; border-radius: 6px; cursor: pointer; background-color: #3498db; color: white; font-weight: 600; font-size: 12px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .danger { background: #e74c3c; } .success { background: #27ae60; } .dark { background: #34495e; }
        .excel-btn { background: #217346; } .csv-btn { background: #d35400; } .dxf-btn { background: #e67e22; }
        .street-view-btn { background: #f1c40f; color: #333; }
        .go-btn { background: #2980b9; color: #fff; flex: 0 0 40px; }
        .profile-btn { background: #8e44ad; width: 100%; margin-top: 5px; display: none; }
        #chart-container { display: none; margin-top: 10px; padding: 10px; background: #fff; border: 1px solid #ddd; border-radius: 4px; }
        canvas { width: 100% !important; height: 150px !important; }
        select, input, textarea { width: 100%; padding: 8px; margin-bottom: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; box-sizing: border-box; }
        textarea { resize: vertical; height: 60px; font-family: inherit; }
        .coord-input { width: 45%; }
        .stat-item { background: #e8f6f3; padding: 8px; margin-top: 10px; border-radius: 6px; font-size: 12px; border: 1px solid #d1f2eb; color: #16a085; }
        
        #save-status { text-align: center; font-size: 12px; margin-bottom: 10px; font-weight: bold; height: 20px; transition: color 0.3s; }
        .saved-ok { color: #27ae60 !important; }
        .saving-now { color: #e67e22 !important; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        .map-label { background: rgba(255, 255, 255, 0.8); border: 1px solid #333; color: #000; font-weight: bold; font-size: 12px; padding: 2px 5px; border-radius: 3px; white-space: nowrap; box-shadow: 1px 1px 3px rgba(0,0,0,0.3); }
        .leaflet-popup-content b { color: #2ecc71; }
        .note-text { color: #555; font-style: italic; font-size: 11px; display: block; margin-top: 4px; border-top: 1px dashed #ccc; padding-top: 2px; }
        .z-loading { color: #e67e22; font-size: 11px; }
        .z-value { color: #8e44ad; font-weight: bold; font-size: 14px; }
        .freehand-btn { background: #d35400; color: white; }
        .freehand-active { background: #e74c3c !important; border: 2px solid #c0392b; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }

        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #2c3e50, #000000); z-index: 10000; display: flex; justify-content: center; align-items: center; flex-direction: column; color: white; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .auth-box { background: white; color: #333; padding: 25px; border-radius: 12px; width: 400px; max-width: 100%; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.6); margin: auto; }
        .auth-box h2 { color: #2ecc71; margin-bottom: 15px; font-size: 20px; }
        .auth-input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 14px; background: #f9f9f9; }
        .auth-btn { width: 100%; padding: 12px; border: none; border-radius: 6px; background: #2ecc71; color: white; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px; }
        .switch-btn { background: none; color: #3498db; text-decoration: underline; cursor: pointer; border: none; margin-top: 15px; display: block; width: 100%; }
        #auth-error { color: #e74c3c; font-size: 13px; margin-bottom: 10px; display: none; background: #fadbd8; padding: 5px; border-radius: 4px; }
        .signup-only { display: none; }
        #logout-btn { background: #c0392b; color: white; margin-top: 20px; width: 100%; }
        #sv-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2999; }
        #sv-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; height: 80%; background: #fff; z-index: 3000; border-radius: 8px; flex-direction: column; }
        #sv-header { background: #2c3e50; color: #fff; padding: 10px; display: flex; justify-content: space-between; height: 40px; align-items: center; }
        #sv-iframe { width: 100%; height: calc(100% - 40px); border: none; }
        .close-sv-btn { background: #e74c3c; color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; }
        
        #name-modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 5000; justify-content: center; align-items: center; }
        #name-modal { background: #fff; padding: 20px; border-radius: 10px; width: 300px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
        #name-modal h3 { margin-top: 0; color: #2c3e50; }
        #feature-name-input { border: 2px solid #2ecc71; font-weight: bold; }
        #save-name-btn { background: #27ae60; color: white; width: 100%; padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9998; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #2ecc71; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="loader"></div>
        <p style="margin-top:15px; color:#2c3e50; font-weight:bold;">Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ...</p>
    </div>

    <div id="name-modal-overlay">
        <div id="name-modal">
            <h3>ğŸ·ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…Ø©</h3>
            <input type="text" id="feature-name-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´ÙƒÙ„ (Ù…Ø«Ù„Ø§Ù‹: ÙˆØ§Ø¯ Ù…Ù„ÙˆÙŠØ©)">
            <textarea id="feature-notes-input" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)..."></textarea>
            <button id="save-name-btn" onclick="saveFeatureName()">Ø­ÙØ¸ ÙÙˆØ±ÙŠ</button>
        </div>
    </div>

    <div id="auth-overlay">
        <div class="auth-box">
            <h1 style="color:#2ecc71; margin:0 0 10px 0;">ZASTopo Pro ğŸ‡²ğŸ‡¦</h1>
            <p style="color:#777; margin-bottom:15px; font-size:13px;">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø·Ø¨ÙˆØºØ±Ø§ÙÙŠ Ù„Ù„Ø¨Ø§Ø­Ø«ÙŠÙ†</p>
            <h2 id="auth-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <div id="auth-error"></div>
            <form id="auth-form" onsubmit="handleAuth(event)">
                <div class="signup-only">
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="fname" class="auth-input" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø´Ø®ØµÙŠ">
                        <input type="text" id="lname" class="auth-input" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„ÙŠ">
                    </div>
                    <select id="university" class="auth-input">
                        <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ø¬Ø§Ù…Ø¹Ø© / Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</option>
                        <option value="ump">Ø¬Ø§Ù…Ø¹Ø© Ù…Ø­Ù…Ø¯ Ø§Ù„Ø£ÙˆÙ„ - ÙˆØ¬Ø¯Ø©</option>
                        <option value="other">Ø¬Ø§Ù…Ø¹Ø© Ø£Ø®Ø±Ù‰ / Ù…Ø¤Ø³Ø³Ø©</option>
                    </select>
                </div>
                <input type="email" id="email" class="auth-input" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required>
                <input type="password" id="password" class="auth-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
                <div class="signup-only">
                    <input type="password" id="confirm-password" class="auth-input" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                </div>
                <button type="submit" class="auth-btn" id="submit-btn">Ø¯Ø®ÙˆÙ„</button>
            </form>
            <button class="switch-btn" onclick="toggleAuthMode()" id="toggle-msg">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
        </div>
    </div>

    <button id="menu-toggle-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>

    <div id="sv-overlay" onclick="closeStreetView()"></div>
    <div id="sv-modal">
        <div id="sv-header">
            <span>Google Street View</span>
            <button class="close-sv-btn" onclick="closeStreetView()"><i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
        <iframe id="sv-iframe" src=""></iframe>
    </div>

    <div id="sidebar">
        <button class="close-sidebar-btn" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
        <h1>ZASTopo Pro</h1>
        <div class="header-info">
            <div class="dev-name">ØªØ·ÙˆÙŠØ±: Ø²ÙƒØ±ÙŠØ§Ø¡ Ø§Ù„Ù…Ø­Ø¬ÙˆØ¨ÙŠ</div>
            <div class="lab-info">Ù…Ø®ØªØ¨Ø± Ø¯ÙŠÙ†Ø§Ù…ÙŠØ© Ø§Ù„Ø£ÙˆØ³Ø§Ø· Ø§Ù„Ø¬Ø§ÙØ© ÙˆØ§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¬Ù‡ÙˆÙŠØ©</div>
            <div class="univ-info">Ø´Ø¹Ø¨Ø© Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§ØŒ Ø¬Ø§Ù…Ø¹Ø© Ù…Ø­Ù…Ø¯ Ø§Ù„Ø£ÙˆÙ„ - ÙˆØ¬Ø¯Ø©</div>
        </div>

        <div id="save-status">Ø¬Ø§Ù‡Ø²</div>

        <h2>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª)</h2>
        <select id="lambert-zone" onchange="updateProjection()">
            <optgroup label="ğŸ‡²ğŸ‡¦ Ø§Ù„Ù…ØºØ±Ø¨ (Merchich)">
                <option value="EPSG:26191" selected>Zone I (Nord)</option>
                <option value="EPSG:26192">Zone II (Centre)</option>
                <option value="EPSG:26194">Zone III (Sud)</option>
                <option value="EPSG:26195">Zone IV (Grand Sud)</option>
            </optgroup>
            <optgroup label="ğŸ‡©ğŸ‡¿ Ø§Ù„Ø¬Ø²Ø§Ø¦Ø± (Nord Sahara)">
                <option value="EPSG:3059">UTM Zone 29N</option>
                <option value="EPSG:3060">UTM Zone 30N</option>
                <option value="EPSG:3061">UTM Zone 31N</option>
                <option value="EPSG:3062">UTM Zone 32N</option>
            </optgroup>
            <optgroup label="ğŸ‡¹ğŸ‡³ ØªÙˆÙ†Ø³ (Carthage)">
                <option value="EPSG:22332">UTM Zone 32N</option>
            </optgroup>
            <optgroup label="ğŸ‡±ğŸ‡¾ Ù„ÙŠØ¨ÙŠØ§ (WGS 84)">
                <option value="EPSG:32632">UTM Zone 32N</option>
                <option value="EPSG:32633">UTM Zone 33N</option>
                <option value="EPSG:32634">UTM Zone 34N</option>
            </optgroup>
            <optgroup label="ğŸ‡²ğŸ‡· Ù…ÙˆØ±ÙŠØªØ§Ù†ÙŠØ§ (WGS 84)">
                <option value="EPSG:32628">UTM Zone 28N</option>
                <option value="EPSG:32629">UTM Zone 29N</option>
            </optgroup>
            <optgroup label="ğŸ‡ªğŸ‡¬ Ù…ØµØ± (Egypt 1907)">
                <option value="EPSG:22992">Red Belt (Cairo/Delta)</option>
                <option value="EPSG:22993">Purple Belt (South)</option>
                <option value="EPSG:22994">Blue Belt (Sinai/Red Sea)</option>
            </optgroup>
        </select>
        
        <div style="display: flex; gap: 5px; margin-bottom: 5px;">
            <input type="text" id="input-x" class="coord-input" placeholder="X / Lat">
            <input type="text" id="input-y" class="coord-input" placeholder="Y / Lng">
            <button class="go-btn" onclick="goToCoordinates()"><i class="fas fa-search"></i></button>
        </div>
        <div class="btn-group">
            <button onclick="locateUser()"><i class="fas fa-location-arrow"></i> Ù…ÙˆÙ‚Ø¹ÙŠ</button>
            <button class="danger" onclick="clearMap()"><i class="fas fa-trash"></i> Ù…Ø³Ø­</button>
        </div>

        <h2>ğŸ“· Ø£Ø¯ÙˆØ§Øª</h2>
        <button id="btn-sv-toggle" class="street-view-btn" style="width:100%; margin-bottom:5px;" onclick="toggleStreetViewMode()">
            <i class="fas fa-street-view"></i> ØªÙØ¹ÙŠÙ„ Street View
        </button>

        <h2>âœï¸ Ø§Ù„Ø±Ø³Ù…</h2>
        <button id="btn-freehand" class="freehand-btn" onclick="toggleFreehand()" style="width:100%; margin-bottom:5px;">
            <i class="fas fa-pencil-alt"></i> ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø­Ø± (Ù„Ù„ÙˆØ§Ø¯)
        </button>

        <div class="btn-group">
            <input type="file" id="file-input" accept=".kml,.gpx,.dxf" style="display: none;" onchange="loadFile(this)">
            <button class="import-btn" onclick="document.getElementById('file-input').click()">ğŸ“‚ Ø§Ø³ØªÙŠØ±Ø§Ø¯ (KML/GPX/DXF)</button>
        </div>
        <div class="btn-group" style="align-items: center;">
            <input type="number" id="buffer-distance" placeholder="Ù…ØªØ±" value="50" style="width: 60px;">
            <button class="buffer-btn" onclick="createBuffer()">â­• Ù†Ø·Ø§Ù‚ Ø¹Ø§Ø²Ù„</button>
        </div>
        <button id="btn-profile" class="profile-btn" onclick="generateRealProfile()">ğŸ”ï¸ Ø§Ù„Ù…Ù‚Ø·Ø¹ Ø§Ù„Ø·Ø¨ÙˆØºØ±Ø§ÙÙŠ</button>
        
        <div id="chart-container">
            <canvas id="elevationChart"></canvas>
            <div id="slope-stats" class="slope-info"></div>
            <div style="text-align:center; margin-top:5px;">
                <button class="dark" style="width:auto; padding:5px 15px;" onclick="downloadProfileImage()">ØªØ­Ù…ÙŠÙ„</button>
            </div>
        </div>

        <h2>ğŸ“¥ ØªØµØ¯ÙŠØ±</h2>
        <button style="background: #2c3e50; width: 100%; margin-bottom: 5px;" onclick="takeScreenshotAndMetadata()">ğŸ“· ØµÙˆØ±Ø© + Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª</button>
        <div class="btn-group">
            <button class="dxf-btn" onclick="downloadDXF()">DXF</button>
            <button class="excel-btn" onclick="downloadExcel()">Excel (Full)</button>
            <button class="csv-btn" onclick="downloadCSV()">CSV</button>
        </div>
        <div class="btn-group">
            <button class="success" onclick="downloadData('geojson')">GeoJSON</button>
            <button class="success" onclick="downloadData('kml')">KML</button>
        </div>
        
        <button id="logout-btn" onclick="logoutUser()"><i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        <div id="stats" class="stat-item">Ø¬Ø§Ù‡Ø²...</div>
    </div>

    <div id="map"></div>
    <div id="coords-bar">
        <span id="metric-coords">X: 0 | Y: 0</span>
        <span id="geo-coords">Lat: 0 | Lng: 0</span>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics-compat.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    <script src="https://unpkg.com/@mapbox/togeojson@0.16.0/togeojson.js"></script>
    <script src="https://unpkg.com/leaflet-geometryutil"></script>
    <script src="https://unpkg.com/leaflet-simple-map-screenshoter"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dxf-parser@1.1.2/dist/dxf-parser.min.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBHjDSoCDrZAh9KIW1LI4H6XxIdeB8YnFw",
            authDomain: "rusle-462022.firebaseapp.com",
            databaseURL: "https://rusle-462022-default-rtdb.firebaseio.com",
            projectId: "rusle-462022",
            storageBucket: "rusle-462022.firebasestorage.app",
            messagingSenderId: "106974487623",
            appId: "1:106974487623:web:f42e4cf7fd2e2218947d62",
            measurementId: "G-YVJL1T2VXM"
        };

        proj4.defs([
            ["EPSG:26191", "+proj=lcc +lat_1=33.3 +lat_0=33.3 +lon_0=-5.4 +k_0=0.999625769 +x_0=500000 +y_0=300000 +a=6378249.2 +b=6356515 +towgs84=31,146,47,0,0,0,0 +units=m +no_defs"],
            ["EPSG:26192", "+proj=lcc +lat_1=29.7 +lat_0=29.7 +lon_0=-5.4 +k_0=0.999615596 +x_0=500000 +y_0=300000 +a=6378249.2 +b=6356515 +towgs84=31,146,47,0,0,0,0 +units=m +no_defs"],
            ["EPSG:26194", "+proj=lcc +lat_1=26.1 +lat_0=26.1 +lon_0=-5.4 +k_0=0.999616304 +x_0=500000 +y_0=400000 +a=6378249.2 +b=6356515 +towgs84=31,146,47,0,0,0,0 +units=m +no_defs"],
            ["EPSG:26195", "+proj=lcc +lat_1=22.5 +lat_0=22.5 +lon_0=-5.4 +k_0=0.999616437 +x_0=500000 +y_0=500000 +a=6378249.2 +b=6356515 +towgs84=31,146,47,0,0,0,0 +units=m +no_defs"],
            ["EPSG:3059", "+proj=utm +zone=29 +ellps=clrk80 +towgs84=-186,-93,310,0,0,0,0 +units=m +no_defs"],
            ["EPSG:3060", "+proj=utm +zone=30 +ellps=clrk80 +towgs84=-186,-93,310,0,0,0,0 +units=m +no_defs"],
            ["EPSG:3061", "+proj=utm +zone=31 +ellps=clrk80 +towgs84=-186,-93,310,0,0,0,0 +units=m +no_defs"],
            ["EPSG:3062", "+proj=utm +zone=32 +ellps=clrk80 +towgs84=-186,-93,310,0,0,0,0 +units=m +no_defs"],
            ["EPSG:22332", "+proj=utm +zone=32 +ellps=clrk80ign +towgs84=-263,6,431,0,0,0,0 +units=m +no_defs"],
            ["EPSG:32628", "+proj=utm +zone=28 +datum=WGS84 +units=m +no_defs"],
            ["EPSG:32629", "+proj=utm +zone=29 +datum=WGS84 +units=m +no_defs"],
            ["EPSG:32632", "+proj=utm +zone=32 +datum=WGS84 +units=m +no_defs"],
            ["EPSG:32633", "+proj=utm +zone=33 +datum=WGS84 +units=m +no_defs"],
            ["EPSG:32634", "+proj=utm +zone=34 +datum=WGS84 +units=m +no_defs"],
            ["EPSG:22992", "+proj=tmerc +lat_0=30 +lon_0=31 +k=1 +x_0=615000 +y_0=810000 +ellps=helmert +towgs84=-130,110,-13,0,0,0,0 +units=m +no_defs"],
            ["EPSG:22993", "+proj=tmerc +lat_0=30 +lon_0=31 +k=1 +x_0=300000 +y_0=1100000 +ellps=helmert +towgs84=-130,110,-13,0,0,0,0 +units=m +no_defs"],
            ["EPSG:22994", "+proj=tmerc +lat_0=30 +lon_0=31 +k=1 +x_0=1100000 +y_0=1100000 +ellps=helmert +towgs84=-130,110,-13,0,0,0,0 +units=m +no_defs"]
        ]);

        var currentZone="EPSG:26191", currentZoneName="Lambert I";
        function updateProjection(){
            var s=document.getElementById('lambert-zone');
            currentZone=s.value; currentZoneName=s.options[s.selectedIndex].text;
            document.getElementById('stats').innerHTML="ØªÙ… Ø§Ù„ØªØºÙŠÙŠØ±: "+currentZoneName;
        }

        var map = L.map('map', {zoomControl: false}).setView([33.3, -5.4], 6);
        L.control.zoom({position: 'topleft'}).addTo(map);
        var snapshoter = L.simpleMapScreenshoter({ hideElementsWithSelectors: ['.leaflet-control-container', '#sidebar', '#coords-bar', '#sv-modal', '#sv-overlay', '#menu-toggle-btn', '#save-status'], mimeType: 'image/jpeg' }).addTo(map);

        var googleHybridMA = L.tileLayer('https://{s}.google.com/vt/lyrs=y&gl=MA&hl=ar&x={x}&y={y}&z={z}',{ maxZoom: 22, subdomains:['mt0','mt1','mt2','mt3'], attribution: 'Google Maps' });
        var googleStreetsMA = L.tileLayer('https://{s}.google.com/vt/lyrs=m&gl=MA&hl=ar&x={x}&y={y}&z={z}',{ maxZoom: 22, subdomains:['mt0','mt1','mt2','mt3'], attribution: 'Google Maps' });
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 });
        var baseMaps = { "ØµÙˆØ± Ø¬ÙˆÙŠØ©": googleHybridMA, "Ø®Ø±ÙŠØ·Ø© Ø·Ø±Ù‚ÙŠØ©": googleStreetsMA, "OSM": osm };
        googleHybridMA.addTo(map);
        L.control.layers(baseMaps, null, {position: 'bottomleft'}).addTo(map);

        var drawnItems = new L.FeatureGroup(); map.addLayer(drawnItems);
        var drawControl = new L.Control.Draw({ edit: { featureGroup: drawnItems, remove: true }, draw: { polygon: true, rectangle: true, circle: false, marker: { repeatMode: true }, polyline: { shapeOptions: { color: '#8e44ad', weight: 4 } } } });
        map.addControl(drawControl);

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }
        map.on('click', function() { if (window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('active'); });

        try {
            firebase.initializeApp(firebaseConfig);
            const analytics = firebase.analytics();
        } catch(e) { console.error("Firebase Config Error:", e); }
        
        let auth, db;
        try {
            auth = firebase.auth();
            db = firebase.database();
        } catch(e) { console.error("DB Init Error:", e); document.getElementById('stats').innerText = "Ø®Ø·Ø£ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª"; }

        let isLoginMode = true;
        
        if(auth) {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    document.getElementById('auth-overlay').style.display = 'none';
                    if(user.displayName) document.querySelector('.dev-name').innerText = "Ù…Ø±Ø­Ø¨Ø§Ù‹: " + user.displayName;
                    loadUserDrawings(user.uid);
                } else {
                    document.getElementById('auth-overlay').style.display = 'flex';
                    drawnItems.clearLayers();
                }
            });
        }

        let saveTimeout;
        function scheduleAutoSave() {
            const statusEl = document.getElementById('save-status');
            statusEl.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";
            statusEl.className = "saving-now";
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => { saveUserDrawings(); }, 3000);
        }

        function saveUserDrawings() {
            if (!auth || !db) return;
            const user = auth.currentUser;
            if (!user) return;
            const statusEl = document.getElementById('save-status');
            const features = [];
            drawnItems.eachLayer(layer => {
                let json = layer.toGeoJSON();
                json.properties.customName = layer.customName || "";
                json.properties.customNotes = layer.customNotes || "";
                features.push(json);
            });
            const dataToSave = { type: "FeatureCollection", features: features };
            db.ref('users/' + user.uid).set({
                drawings: JSON.stringify(dataToSave),
                timestamp: Date.now()
            }, (error) => {
                if (error) { statusEl.innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸"; } 
                else { 
                    statusEl.innerText = "ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…"; 
                    statusEl.className = "saved-ok"; 
                    setTimeout(() => { statusEl.innerText = "Ø¬Ø§Ù‡Ø²"; statusEl.className = ""; }, 3000); 
                }
            });
        }

        // === ğŸŸ¢ Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù„Ø¥Ø®ÙØ§Ø¡ "DXF Import" ===
        function loadUserDrawings(uid) {
            if (!db) return;
            document.getElementById('loading-overlay').style.display = 'flex';
            db.ref('users/' + uid).once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data && data.drawings) {
                    const geojsonData = JSON.parse(data.drawings);
                    L.geoJSON(geojsonData, {
                        onEachFeature: function (feature, layer) {
                            if (feature.properties) {
                                let name = feature.properties.customName;
                                layer.customName = name;
                                layer.customNotes = feature.properties.customNotes;
                                
                                // ğŸŸ¢ Ø§Ù„Ø´Ø±Ø·: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø§Ø³Ù… Ù„ÙŠØ³ "DXF Import" ÙˆÙ„ÙŠØ³ ÙØ§Ø±ØºØ§Ù‹ØŒ Ø£Ø¸Ù‡Ø± Ø§Ù„Ù„Ø§ÙØªØ©
                                if(name && name !== "DXF Import" && name.trim() !== "") {
                                    layer.bindTooltip(name, {permanent: true, direction: "center", className: "map-label"});
                                }
                            }
                            drawnItems.addLayer(layer);
                            attachPopup(layer);
                        }
                    });
                    if(drawnItems.getLayers().length > 0) map.fitBounds(drawnItems.getBounds());
                }
                document.getElementById('loading-overlay').style.display = 'none';
            });
        }

        map.on(L.Draw.Event.CREATED, function(e) { finishDrawing(e.layer); });
        map.on(L.Draw.Event.EDITED, function(e) { e.layers.eachLayer(function(layer) { attachPopup(layer); }); scheduleAutoSave(); });
        map.on(L.Draw.Event.DELETED, function() { selectedPolyline=null; lastSelectedLayer=null; document.getElementById('btn-profile').style.display='none'; document.getElementById('stats').innerHTML="ØªÙ… Ø§Ù„Ø­Ø°Ù"; scheduleAutoSave(); });

        let currentLayerToName = null;
        function finishDrawing(layer) { 
            currentLayerToName = layer; 
            document.getElementById('feature-name-input').value = "";
            document.getElementById('feature-notes-input').value = "";
            document.getElementById('name-modal-overlay').style.display = 'flex'; 
            document.getElementById('feature-name-input').focus(); 
        }
        
        function saveFeatureName() {
            let name = document.getElementById('feature-name-input').value;
            let notes = document.getElementById('feature-notes-input').value;
            
            // ğŸŸ¢ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒØªØ¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ø³Ù…Ø§Ù‹ØŒ Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ ÙˆÙ„Ø§ ØªØ³Ù…ÙŠÙ‡ "Ø¹Ù†ØµØ±"
            if(!name) name = ""; 
            
            currentLayerToName.customName = name;
            currentLayerToName.customNotes = notes;
            
            // ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø§Ø³Ù…ØŒ Ø£Ø¶Ù Ø§Ù„Ù„Ø§ÙØªØ©
            if(name !== "") {
                currentLayerToName.bindTooltip(name, {permanent: true, direction: "center", className: "map-label"}).openTooltip();
            }
            
            drawnItems.addLayer(currentLayerToName);
            attachPopup(currentLayerToName);
            handleSelection(currentLayerToName, (currentLayerToName instanceof L.Polygon)?'polygon':(currentLayerToName instanceof L.Polyline)?'polyline':'marker');
            document.getElementById('name-modal-overlay').style.display = 'none';
            currentLayerToName = null;
            
            // Ø­ÙØ¸ ÙÙˆØ±ÙŠ
            saveUserDrawings();
        }

        // === ğŸŸ¢ ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ³Ù…ÙŠØ© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ===
        function loadFile(i) {
            if(i.files[0]) {
                var r=new FileReader();
                r.onload=function(e) {
                    try {
                        let filename = i.files[0].name.toLowerCase();
                        if(filename.endsWith('.dxf')) {
                            var parser = new DxfParser();
                            var dxf = parser.parseSync(e.target.result);
                            dxf.entities.forEach(entity => {
                                let layer;
                                // ... (Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª) ...
                                if(entity.type === 'POINT' || entity.type === 'INSERT') { let x = entity.position.x; let y = entity.position.y; try { let l = proj4(currentZone, "EPSG:4326", [x, y]); layer = L.marker([l[1], l[0]]); } catch(err){} } 
                                else if(entity.type === 'LWPOLYLINE' || entity.type === 'POLYLINE') { let latlngs = []; entity.vertices.forEach(v => { try { let l = proj4(currentZone, "EPSG:4326", [v.x, v.y]); latlngs.push([l[1], l[0]]); } catch(err){} }); if(latlngs.length > 0) { layer = (entity.shape || entity.closed) ? L.polygon(latlngs, {color: '#e74c3c'}) : L.polyline(latlngs, {color: '#e74c3c'}); } } 
                                else if(entity.type === 'LINE') { let latlngs = []; entity.vertices.forEach(v => { try { let l = proj4(currentZone, "EPSG:4326", [v.x, v.y]); latlngs.push([l[1], l[0]]); } catch(err){} }); if(latlngs.length > 0) layer = L.polyline(latlngs, {color: '#e74c3c'}); }

                                if(layer) {
                                    layer.customName = ""; // ğŸŸ¢ Ù„Ø§ ØªØ³Ù…ÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                                    drawnItems.addLayer(layer);
                                    attachPopup(layer);
                                }
                            });
                            map.fitBounds(drawnItems.getBounds());
                            document.getElementById('stats').innerHTML="ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ DXF";
                            saveUserDrawings(); // Ø­ÙØ¸ ÙÙˆØ±ÙŠ
                        } else {
                            // KML/GPX
                            var p=new DOMParser(), d=p.parseFromString(e.target.result,"text/xml");
                            var g=filename.endsWith('.gpx')?toGeoJSON.gpx(d):toGeoJSON.kml(d);
                            var l=L.geoJSON(g,{style:{color:"#d35400",weight:4},pointToLayer:(f,ll)=>L.marker(ll),onEachFeature:(f,l)=>{
                                l.customName = f.properties.name || ""; // Ø§Ù„Ø§Ø³Ù… Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø£Ùˆ ÙØ§Ø±Øº
                                if(l.customName) l.bindTooltip(l.customName, {permanent:true, className:'map-label'});
                                drawnItems.addLayer(l);
                                attachPopup(l);
                            }});
                            if(drawnItems.getLayers().length>0) { map.fitBounds(drawnItems.getBounds()); document.getElementById('stats').innerHTML="ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯"; saveUserDrawings(); }
                        }
                        if(window.innerWidth<=768) toggleSidebar();
                    } catch(x){ console.log(x); alert("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­");}
                }; r.readAsText(i.files[0]);
            }
        }

        // ... (Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù: toggleAuthMode, handleAuth, Freehand, downloadDXF, etc. ÙƒÙ…Ø§ Ù‡ÙŠ)
        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            const signupFields = document.querySelectorAll('.signup-only');
            if (isLoginMode) {
                document.getElementById('auth-title').innerText = "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
                document.getElementById('submit-btn').innerText = "Ø¯Ø®ÙˆÙ„";
                document.getElementById('toggle-msg').innerText = "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯";
                signupFields.forEach(el => el.style.display = 'none');
            } else {
                document.getElementById('auth-title').innerText = "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯";
                document.getElementById('submit-btn').innerText = "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨";
                document.getElementById('toggle-msg').innerText = "Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
                signupFields.forEach(el => el.style.display = 'block');
            }
            document.getElementById('auth-error').style.display = 'none';
        }

        function handleAuth(event) {
            event.preventDefault(); 
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const errorMsg = document.getElementById('auth-error');
            errorMsg.style.display = 'none';

            if (isLoginMode) {
                auth.signInWithEmailAndPassword(email, pass).catch((error) => {
                    errorMsg.innerText = "Ø®Ø·Ø£: ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±";
                    errorMsg.style.display = 'block';
                });
            } else {
                const fname = document.getElementById('fname').value;
                const lname = document.getElementById('lname').value;
                const confirmPass = document.getElementById('confirm-password').value;
                const university = document.getElementById('university').value;
                if(!fname || !lname || !university) { errorMsg.innerText = "Ø§Ù…Ù„Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„"; errorMsg.style.display = 'block'; return; }
                if(pass !== confirmPass) { errorMsg.innerText = "ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©"; errorMsg.style.display = 'block'; return; }
                if(pass.length < 6) { errorMsg.innerText = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‚ØµÙŠØ±Ø©"; errorMsg.style.display = 'block'; return; }
                auth.createUserWithEmailAndPassword(email, pass).then((userCredential) => {
                    userCredential.user.updateProfile({ displayName: fname + " " + lname }).then(() => {
                        alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨!"); location.reload();
                    });
                }).catch((error) => { errorMsg.innerText = error.message; errorMsg.style.display = 'block'; });
            }
        }
        function logoutUser() { auth.signOut().then(() => { location.reload(); }); }

        var isFreehand = false;
        var freehandPolyline = null;
        function toggleFreehand() {
            isFreehand = !isFreehand;
            var btn = document.getElementById('btn-freehand');
            if (isFreehand) {
                btn.classList.add('freehand-active');
                btn.innerHTML = '<i class="fas fa-hand-paper"></i> Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø­Ø±';
                map.dragging.disable(); map.touchZoom.disable(); map.doubleClickZoom.disable(); map.scrollWheelZoom.disable(); map.getContainer().style.cursor = 'crosshair';
                if(window.innerWidth <= 768) toggleSidebar();
            } else {
                btn.classList.remove('freehand-active');
                btn.innerHTML = '<i class="fas fa-pencil-alt"></i> ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø­Ø± (Ù„Ù„ÙˆØ§Ø¯)';
                map.dragging.enable(); map.touchZoom.enable(); map.doubleClickZoom.enable(); map.scrollWheelZoom.enable(); map.getContainer().style.cursor = '';
            }
        }
        map.on('mousedown touchstart', function(e) { if (!isFreehand) return; var latlng = e.latlng || e.touches[0].latlng; freehandPolyline = L.polyline([latlng], {color: '#e74c3c', weight: 4}).addTo(map); });
        map.on('mousemove touchmove', function(e) { if (!isFreehand || !freehandPolyline) return; var latlng = e.latlng; if(e.type === 'touchmove') { var touch = e.originalEvent.touches[0]; latlng = map.mouseEventToLatLng(touch); } freehandPolyline.addLatLng(latlng); });
        map.on('mouseup touchend', function() { if (!isFreehand || !freehandPolyline) return; finishDrawing(freehandPolyline); freehandPolyline = null; });

        function attachPopup(layer) {
            let name = layer.customName || "Ø¹Ù†ØµØ±";
            let notes = layer.customNotes ? `<span class="note-text">ğŸ“ ${layer.customNotes}</span>` : "";
            let content = `<div style="text-align:center; border-bottom:1px solid #eee; margin-bottom:5px;"><b>${name}</b>${notes}</div>`;
            if (layer instanceof L.Marker) {
                let ll = layer.getLatLng();
                try {
                    let p = proj4("EPSG:4326", currentZone, [ll.lng, ll.lat]);
                    content += `<b>ğŸ“ Ù†Ù‚Ø·Ø©</b><br>Lat: ${ll.lat.toFixed(5)}<br>Lng: ${ll.lng.toFixed(5)}<br>X: ${p[0].toFixed(0)} | Y: ${p[1].toFixed(0)}<br><span class="z-loading">â³ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Z...</span>`;
                    layer.bindPopup(content).openPopup();
                    fetch(`https://api.open-meteo.com/v1/elevation?latitude=${ll.lat}&longitude=${ll.lng}`).then(r=>r.json()).then(d=>{if(d.elevation) layer.setPopupContent(content.replace('<span class="z-loading">â³ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Z...</span>', `<span class="z-value">Z: ${d.elevation[0]} m</span>`));});
                } catch(e) {}
            } else if (layer instanceof L.Polyline && !(layer instanceof L.Polygon)) {
                let d = 0, ll = layer.getLatLngs(); if(Array.isArray(ll[0]) && !ll[0].lat) ll = ll.flat(); 
                for(var i=0; i<ll.length-1; i++) d += ll[i].distanceTo(ll[i+1]);
                content += `<b>ğŸ“ Ù…Ø³Ø§ÙØ©</b><br>${(d/1000).toFixed(3)} km<br>${d.toFixed(0)} m`;
                layer.bindPopup(content).openPopup();
            } else if (layer instanceof L.Polygon) {
                let area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
                content += `<b>ğŸ“ Ù…Ø³Ø§Ø­Ø©</b><br>${(area/10000).toFixed(4)} Ha<br>${area.toFixed(0)} mÂ²`;
                layer.bindPopup(content).openPopup();
            }
        }

        var selectedPolyline=null, lastSelectedLayer=null, isStreetViewActive=false, pegmanMarker=null;
        function toggleStreetViewMode() {
            isStreetViewActive = !isStreetViewActive;
            var btn = document.getElementById('btn-sv-toggle');
            if (isStreetViewActive) {
                btn.style.background = '#f39c12'; btn.style.color = '#000';
                btn.innerHTML = '<i class="fas fa-crosshairs"></i> Ø§Ù†Ù‚Ø± ÙÙŠ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¢Ù†';
                if(window.innerWidth <= 768) toggleSidebar();
            } else {
                btn.style.background = '#34495e'; btn.style.color = '#fff';
                btn.innerHTML = '<i class="fas fa-street-view"></i> ØªÙØ¹ÙŠÙ„ Street View';
                if(pegmanMarker) map.removeLayer(pegmanMarker);
            }
        }
        map.on('click', function(e) { if (isStreetViewActive) { openStreetViewModal(e.latlng.lat, e.latlng.lng); if(pegmanMarker) map.removeLayer(pegmanMarker); pegmanMarker = L.marker(e.latlng).addTo(map); toggleStreetViewMode(); } });
        function openStreetViewModal(lat, lng) { document.getElementById('sv-overlay').style.display = 'block'; document.getElementById('sv-modal').style.display = 'flex'; document.getElementById('sv-iframe').src = `https://maps.google.com/maps?q=&layer=c&cbll=${lat},${lng}&cbp=11,0,0,0,0&output=svembed`; }
        function closeStreetView() { document.getElementById('sv-overlay').style.display = 'none'; document.getElementById('sv-modal').style.display = 'none'; document.getElementById('sv-iframe').src = ""; }
        function goToCoordinates() {
            var x = parseFloat(document.getElementById('input-x').value), y = parseFloat(document.getElementById('input-y').value);
            if (isNaN(x) || isNaN(y)) return alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…");
            if (x > 1000 || y > 1000) { try { var l=proj4(currentZone,"EPSG:4326",[x,y]); map.setView([l[1],l[0]],16); L.marker([l[1],l[0]]).addTo(map); } catch(e){alert("Ø®Ø·Ø£ ØªØ­ÙˆÙŠÙ„");} }
            else { map.setView([x,y],16); L.marker([x,y]).addTo(map); }
            if(window.innerWidth <= 768) toggleSidebar();
        }
        function handleSelection(l, t) {
            lastSelectedLayer=l; calcStats(l,t);
            if(l.setStyle) { var c=l.options.color; l.setStyle({color:'#f1c40f'}); setTimeout(()=>l.setStyle({color:c}),500); }
            if(t==='polyline' && !(l instanceof L.Polygon)) { selectedPolyline=l; document.getElementById('btn-profile').style.display='block'; }
            else document.getElementById('btn-profile').style.display='none';
        }
        async function generateRealProfile() {
            if(!selectedPolyline) return;
            document.getElementById('stats').innerHTML="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...";
            var raw=selectedPolyline.getLatLngs(); if(Array.isArray(raw[0]) && !raw[0].lat) raw=raw.flat();
            var total=0, dists=[0]; for(var i=0; i<raw.length-1; i++) { total+=raw[i].distanceTo(raw[i+1]); dists.push(total); }
            var num=100, step=total/(num-1), sampled=[];
            for(var k=0; k<num; k++) {
                var target=k*step;
                for(var i=0; i<dists.length-1; i++) {
                    if(target>=dists[i] && target<=dists[i+1]) {
                        var len=dists[i+1]-dists[i]; if(len==0){sampled.push(raw[i]);break;}
                        var r=(target-dists[i])/len;
                        sampled.push(L.latLng(raw[i].lat+(raw[i+1].lat-raw[i].lat)*r, raw[i].lng+(raw[i+1].lng-raw[i].lng)*r)); break;
                    }
                }
            }
            var lats=sampled.map(l=>l.lat.toFixed(5)), lngs=sampled.map(l=>l.lng.toFixed(5));
            try {
                var res=await fetch(`https://api.open-meteo.com/v1/elevation?latitude=${lats}&longitude=${lngs}`);
                var data=await res.json();
                if(data.elevation) { drawChart(data.elevation, sampled); calcSlope(data.elevation, total); document.getElementById('stats').innerHTML="ØªÙ… Ø§Ù„Ø±Ø³Ù…"; }
            } catch(e) { document.getElementById('stats').innerHTML="Ø®Ø·Ø£ Ø§ØªØµØ§Ù„"; }
        }
        function calcSlope(e, d) {
            var min=Math.min(...e), max=Math.max(...e), diff=max-min, pct=(diff/d)*100, deg=Math.atan(diff/d)*(180/Math.PI);
            document.getElementById('slope-stats').innerHTML=`Ø§Ù†Ø­Ø¯Ø§Ø±: <b>${pct.toFixed(1)}%</b> | Min: ${min}m | Max: ${max}m`;
        }
        var ch=null;
        function drawChart(e, ll) {
            document.getElementById('chart-container').style.display='block';
            var ctx=document.getElementById('elevationChart').getContext('2d'), d=[0], t=0;
            for(var i=0;i<ll.length-1;i++){t+=ll[i].distanceTo(ll[i+1]);d.push((t/1000).toFixed(2));}
            if(ch) ch.destroy();
            ch=new Chart(ctx,{type:'line',data:{labels:d,datasets:[{label:'Ù…ØªØ±',data:e,borderColor:'#8e44ad',backgroundColor:'rgba(142,68,173,0.3)',fill:true,pointRadius:0}]},options:{responsive:true,scales:{x:{display:true},y:{display:true}}}});
        }
        function createBuffer() {
            if(!lastSelectedLayer) return alert("Ø­Ø¯Ø¯ Ø¹Ù†ØµØ±Ø§Ù‹");
            var d=parseFloat(document.getElementById('buffer-distance').value);
            try { 
                var buf = L.geoJSON(turf.buffer(lastSelectedLayer.toGeoJSON(), d/1000, {units:'kilometers'}),{style:{color:'#16a085',dashArray:'5,5'}});
                var baseName = lastSelectedLayer.customName || "Ø¹Ù†ØµØ±";
                buf.eachLayer(l => { l.customName = "Buffer: " + baseName; l.bindTooltip(l.customName, {permanent:true, className:'map-label'}); drawnItems.addLayer(l); });
                document.getElementById('stats').innerHTML="ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡"; 
                scheduleAutoSave(); 
            } catch(e){alert("Ø®Ø·Ø£");}
        }
        function downloadDXF(){
            if(!drawnItems.getLayers().length) return alert("ÙØ§Ø±Øº");
            let d="0\nSECTION\n2\nHEADER\n9\n$ACADVER\n1\nAC1009\n0\nENDSEC\n0\nSECTION\n2\nENTITIES\n";
            drawnItems.eachLayer(l=>{
                if(l.feature && l.feature.geometry.type==='GeometryCollection') return;
                // Ø­Ø°ÙÙ†Ø§ ÙƒÙˆØ¯ Ø§Ù„Ù€ TEXT Ù…Ù† Ù‡Ù†Ø§ Ù„ÙƒÙŠ Ù„Ø§ ÙŠØ¸Ù‡Ø± Ø§Ù„Ø§Ø³Ù…
                if(l instanceof L.Marker) { 
                    try{
                        let p=proj4("EPSG:4326",currentZone,[l.getLatLng().lng,l.getLatLng().lat]); 
                        d+=`0\nPOINT\n8\nPoints\n10\n${p[0]}\n20\n${p[1]}\n30\n0.0\n`;
                    }catch(e){} 
                }
                else if(l instanceof L.Polyline||l instanceof L.Polygon) {
                    let ll=l.getLatLngs(); if(Array.isArray(ll[0])&&!ll[0].lat) ll=ll.flat();
                    let closed = (l instanceof L.Polygon) ? 1 : 0;
                    d+=`0\nLWPOLYLINE\n8\nGeometry\n90\n${ll.length}\n70\n${closed}\n`;
                    let firstP = null;
                    ll.forEach((p, index)=>{
                        let c=proj4("EPSG:4326",currentZone,[p.lng,p.lat]); 
                        d+=`10\n${c[0]}\n20\n${c[1]}\n`;
                    });
                }
            });
            d+="0\nENDSEC\n0\nEOF"; downloadFile("ZASTopo_Pro.dxf",d,"application/dxf");
        }
        function downloadProfileImage(){var a=document.createElement('a');a.download='profile.png';a.href=document.getElementById('elevationChart').toDataURL();a.click();}
        function calcStats(l,t){ if(t==='polyline'){var d=0,ll=l.getLatLngs();for(var i=0;i<ll.length-1;i++)d+=ll[i].distanceTo(ll[i+1]);document.getElementById('stats').innerHTML=`ğŸ“ ${(d/1000).toFixed(3)} ÙƒÙ…`;} else if(t==='polygon') document.getElementById('stats').innerHTML=`ğŸ“ ${(L.GeometryUtil.geodesicArea(l.getLatLngs()[0])/10000).toFixed(4)} Ù‡ÙƒØªØ§Ø±`; else document.getElementById('stats').innerHTML="ğŸ“ Ø¹Ù†ØµØ±"; }
        map.on('mousemove',e=>{ try{var p=proj4("EPSG:4326",currentZone,[e.latlng.lng,e.latlng.lat]); document.getElementById('metric-coords').innerText=`X:${p[0].toFixed(0)} Y:${p[1].toFixed(0)}`; document.getElementById('geo-coords').innerText=`Lat:${e.latlng.lat.toFixed(5)} Lng:${e.latlng.lng.toFixed(5)}`;}catch(x){} });
        function downloadFile(n,c,t){var b=new Blob([c],{type:t}),a=document.createElement("a");a.href=URL.createObjectURL(b);a.download=n;a.click();}
        function downloadData(f){var d=drawnItems.toGeoJSON(); if(!d.features.length)return alert("ÙØ§Ø±Øº"); downloadFile("data."+f, f==='geojson'?JSON.stringify(d):toKML(d), f==='geojson'?"application/json":"application/xml"); }
        function toKML(g){return `<?xml version="1.0"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document>${g.features.map(f=>`<Placemark><name>${f.properties.name || "Element"}</name>${f.geometry.type==="Point"?`<Point><coordinates>${f.geometry.coordinates.join(",")}</coordinates></Point>`:`<LineString><coordinates>${f.geometry.coordinates.map(c=>c.join(",")).join(" ")}</coordinates></LineString>`}</Placemark>`).join("")}</Document></kml>`;}
        function takeScreenshotAndMetadata(){
            var b=map.getBounds(), m=`TL: ${b.getNorthEast().lat}, ${b.getSouthWest().lng}\nBR: ${b.getSouthWest().lat}, ${b.getNorthEast().lng}`;
            downloadFile("meta.txt",m,"text/plain");
            setTimeout(()=>snapshoter.takeScreen('image').then(i=>{var a=document.createElement('a'); a.download="map.jpg"; a.href=i; a.click();}),500);
        }
        function clearMap() { drawnItems.clearLayers(); selectedPolyline=null; lastSelectedLayer=null; document.getElementById('btn-profile').style.display='none'; document.getElementById('chart-container').style.display='none'; document.getElementById('stats').innerHTML="ØªÙ… Ø§Ù„Ù…Ø³Ø­"; scheduleAutoSave(); }
        function locateUser() { map.locate({setView:true, maxZoom:15}); if(window.innerWidth<=768) toggleSidebar(); }

        async function downloadExcel() {
            document.getElementById('stats').innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±...";
            var data = [];
            var layers = drawnItems.getLayers();
            for (const l of layers) {
                let row = { Name: l.customName || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…", Notes: l.customNotes || "", Type: "Unknown" };
                if (l instanceof L.Marker) {
                    row.Type = "Point";
                    let ll = l.getLatLng();
                    let p = proj4("EPSG:4326", currentZone, [ll.lng, ll.lat]);
                    row.X = p[0].toFixed(2); row.Y = p[1].toFixed(2);
                    try { let res = await fetch(`https://api.open-meteo.com/v1/elevation?latitude=${ll.lat}&longitude=${ll.lng}`); let json = await res.json(); row.Z_m = json.elevation ? json.elevation[0] : 0; } catch(e) { row.Z_m = "Err"; }
                } else if (l instanceof L.Polyline || l instanceof L.Polygon) {
                    row.Type = (l instanceof L.Polygon) ? "Polygon" : "Line";
                    let latlngs = l.getLatLngs(); if(Array.isArray(latlngs[0]) && !latlngs[0].lat) latlngs = latlngs.flat();
                    let sample = latlngs.filter((_, i) => i % Math.max(1, Math.floor(latlngs.length/20)) === 0);
                    let lats = sample.map(p => p.lat).join(','); let lngs = sample.map(p => p.lng).join(',');
                    if(l instanceof L.Polygon) {
                        row.Area_Ha = (L.GeometryUtil.geodesicArea(l.getLatLngs()[0])/10000).toFixed(4);
                        let center = l.getBounds().getCenter();
                        let cp = proj4("EPSG:4326", currentZone, [center.lng, center.lat]);
                        row.Center_X = cp[0].toFixed(2); row.Center_Y = cp[1].toFixed(2);
                        let boundary = latlngs.map(p => {
                            let xy = proj4("EPSG:4326", currentZone, [p.lng, p.lat]);
                            return `(${xy[0].toFixed(0)},${xy[1].toFixed(0)})`;
                        }).join(" - ");
                        row.Boundary_Coords = boundary;
                    }
                    else { let d=0; for(var i=0;i<latlngs.length-1;i++)d+=latlngs[i].distanceTo(latlngs[i+1]); row.Length_m = d.toFixed(2); }
                    try { let res = await fetch(`https://api.open-meteo.com/v1/elevation?latitude=${lats}&longitude=${lngs}`); let json = await res.json(); if(json.elevation) { row.Avg_Z = (json.elevation.reduce((a, b) => a + b, 0)/json.elevation.length).toFixed(1); row.Min_Z = Math.min(...json.elevation); row.Max_Z = Math.max(...json.elevation); } } catch(e) { row.Avg_Z = "N/A"; }
                }
                data.push(row);
            }
            var w = XLSX.utils.json_to_sheet(data), b = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(b, w, "Data"); XLSX.writeFile(b, "ZASTopo_Pro_Data.xlsx");
            document.getElementById('stats').innerHTML = "ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±";
        }
        async function downloadCSV() { await downloadExcel(); }
    </script>
</body>
</html>
